<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="navigation.schedule">Daily Schedule - MediHelper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
        <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='index.html'" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h1 class="text-xl font-bold text-gray-900" data-i18n="navigation.schedule">Daily Schedule</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button id="datePicker" class="text-gray-500 hover:text-gray-700 flex items-center space-x-1">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <!-- Date Quick Select Dropdown -->
                        <div id="dateDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                                            <div class="py-1">
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span data-i18n="time.today">Today</span>
                    </button>
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                        </svg>
                        <span data-i18n="time.yesterday">Yesterday</span>
                    </button>
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        <span data-i18n="time.tomorrow">Tomorrow</span>
                    </button>
                    <hr class="my-1 border-gray-200">
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span data-i18n="time.thisWeek">This week</span>
                    </button>
                    <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span data-i18n="time.nextWeek">Next week</span>
                    </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Page Header with Greeting -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2" data-greeting data-i18n="dashboard.greeting">Hi there</h2>
            <p class="text-gray-600" data-i18n="schedule.description">Here's your medication schedule for today</p>
        </div>
        
        <!-- Date Header -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h2 id="currentDate" class="text-2xl font-bold text-gray-900" data-i18n="time.today">Today</h2>
                    <p id="dateSubtitle" class="text-gray-600" data-i18n="schedule.yourSchedule">Your medication schedule</p>
                </div>
                <div class="flex space-x-2">
                    <button id="toggleTaken" class="flex items-center px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors border border-gray-200" title="Show/hide completed doses">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        <span id="toggleTakenText" data-i18n="schedule.showTaken">Show Taken</span>
                    </button>
                    <button id="prevDay" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <button id="refreshSchedule" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors" title="Refresh Schedule (Double-click to force refresh)">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                    <button id="nextDay" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Information -->
        <div class="space-y-4 mb-6">
            <!-- Verification Note -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <p class="text-sm text-blue-800 font-medium" data-i18n="schedule.doseTrackingTitle">How Dose Tracking Works</p>
                        <p class="text-sm text-blue-700" data-i18n="schedule.doseTrackingText">Use the "Verify" tab to document doses with photo verification. Once taken, medications are hidden by default - click "Show Taken" to view completed doses.</p>
                    </div>
                </div>
            </div>
            
            <!-- Notification Settings -->
            <div id="notificationSettings" class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 14h.01M4 14h.01"></path>
                        </svg>
                        <div>
                            <p class="text-sm text-purple-800 font-medium" data-i18n="schedule.notificationsTitle">Simple Notifications</p>
                            <p class="text-sm text-purple-700" id="notificationStatus" data-i18n="schedule.notificationsText">Click "Enable" to get medication reminders</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="enableNotifications" class="px-3 py-1 text-xs font-medium text-purple-700 bg-purple-100 hover:bg-purple-200 rounded-lg transition-colors hidden">
                            Enable/Restart
                        </button>


                        <span id="notificationIcon" class="w-3 h-3 rounded-full"></span>
                    </div>
                </div>
            </div>
            
            <!-- Status Indicator -->
            <div id="statusIndicator" class="bg-green-50 border border-green-200 rounded-lg p-4 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></button>
                        </svg>
                        <span class="text-sm text-green-800 font-medium" id="statusText">Real-time updates active</span>
                    </div>
                    <span class="text-xs text-green-600" id="updateTime"></span>
                </div>
            </div>
        </div>

        <!-- Schedule Sections -->
        <div class="space-y-6">
            <!-- Morning Section -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gradient-to-r from-orange-50 to-yellow-50 px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900" data-i18n="medication.timeSlots.morning">Morning</h3>
                            <p class="text-sm text-gray-600" data-i18n="time.timeRanges.morning">8:00 AM - 12:00 PM</p>
                        </div>
                    </div>
                </div>
                <div id="morningMeds" class="p-6">
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p data-i18n="schedule.noMedicationsScheduled">No medications scheduled</p>
                    </div>
                </div>
            </div>

            <!-- Afternoon Section -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900" data-i18n="medication.timeSlots.afternoon">Afternoon</h3>
                            <p class="text-sm text-gray-600" data-i18n="time.timeRanges.afternoon">12:00 PM - 5:00 PM</p>
                        </div>
                    </div>
                </div>
                <div id="afternoonMeds" class="p-6">
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p data-i18n="schedule.noMedicationsScheduled">No medications scheduled</p>
                    </div>
                </div>
            </div>

            <!-- Evening Section -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gradient-to-r from-purple-50 to-pink-50 px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900" data-i18n="medication.timeSlots.evening">Evening</h3>
                            <p class="text-sm text-gray-600" data-i18n="time.timeRanges.evening">5:00 PM - 12:00 AM</p>
                        </div>
                    </div>
                </div>
                <div id="eveningMeds" class="p-6">
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01-2 2z"></path>
                        </svg>
                        <p data-i18n="schedule.noMedicationsScheduled">No medications scheduled</p>
                    </div>
                </div>
            </div>

            <!-- Refill Reminders Section -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gradient-to-r from-red-50 to-orange-50 px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900" data-i18n="schedule.refillReminders.title">Refill Reminders</h3>
                            <p class="text-sm text-gray-600" data-i18n="schedule.refillReminders.description">Medications that need attention</p>
                        </div>
                    </div>
                </div>
                <div id="refillReminders" class="p-6">
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p data-i18n="common.loading">Loading refill reminders...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="mt-8 bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="schedule.quickActions">Quick Actions</h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <button onclick="window.location.href='verify.html'" class="flex items-center justify-center space-x-3 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span data-i18n="schedule.quickVerify">Quick Verify</span>
                </button>
                <button onclick="window.location.href='add-medication.html'" class="flex items-center justify-center space-x-3 bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span data-i18n="actions.addMedication">Add Medication</span>
                </button>
                <button onclick="window.location.href='history.html'" class="flex items-center justify-center space-x-3 bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <span data-i18n="schedule.viewHistory">View History</span>
                </button>

            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mb-4"></div>
                <p class="text-gray-700" data-i18n="common.loading">Loading schedule...</p>
            </div>
        </div>
    </main>

        <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-around py-2">
                <button class="flex flex-col items-center py-2 px-3 text-gray-500 hover:text-gray-700" onclick="window.location.href='index.html'">
                    <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                    <span class="text-xs" data-i18n="navigation.home">Home</span>
                </button>
                <button class="flex flex-col items-center py-2 px-3 text-primary-600">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span class="text-xs font-medium" data-i18n="navigation.schedule">Schedule</span>
                </button>
                <button class="flex flex-col items-center py-2 px-3 text-gray-500 hover:text-gray-700" onclick="window.location.href='verify.html'">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-xs" data-i18n="navigation.verify">Verify</span>
                </button>
                <button class="flex flex-col items-center py-2 px-3 text-gray-500 hover:text-gray-700" onclick="window.location.href='add-medication.html'">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span class="text-xs" data-i18n="navigation.add">Add</span>
                </button>
                <button class="flex flex-col items-center py-2 px-3 text-gray-500 hover:text-gray-700" onclick="window.location.href='history.html'">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <span class="text-xs" data-i18n="navigation.history">History</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Add bottom padding to account for fixed navigation -->
    <div class="h-20"></div>

    <script>
        // Create a local date that represents "today" in the user's timezone
        // This avoids timezone conversion issues
        let currentDate = new Date();
        // Reset to midnight local time to avoid timezone shifts
        currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
        
        // State for showing taken doses
        let showTakenDoses = false;
        let autoRefreshInterval;
        let isLoadingSchedule = false; // Prevent recursive loading
        let scheduleLoadTimeout = null; // Debounce mechanism
        let isUpdatingSchedule = false; // Prevent schedule updates during display
        let lastScheduleUpdate = null; // Track when schedule was last updated

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            
            // Listen for language changes and refresh content
            if (window.i18n) {
                window.addEventListener('languageChanged', function() {
                    console.log('🔄 Language changed, refreshing content...');
                    // Small delay to ensure i18n system has fully updated
                    setTimeout(() => {
                        refreshAllContent();
                    }, 100);
                });
                
                // Also check if language has changed since page load and refresh if needed
                const currentLang = window.i18n.getCurrentLanguage();
                const savedLang = localStorage.getItem('language') || 'en';
                if (currentLang !== savedLang) {
                    console.log('🔄 Language preference changed, refreshing content...');
                    setTimeout(() => {
                        refreshAllContent();
                    }, 100);
                }
            }
    
            updateDateDisplay();
            updateToggleButton(); // Initialize button state
            loadSchedule();
            
            // Initialize simple notifications AFTER schedule is loaded
            setTimeout(() => {
                initializeNotifications();
            }, 1000); // Wait 1 second for schedule to load
            
            // Set up navigation buttons
            document.getElementById('prevDay').addEventListener('click', () => {
                console.log('⬅️ Previous day clicked');
                console.log('📅 Current date before:', currentDate.toDateString());
                // Create new date to avoid timezone issues with setDate
                currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() - 1);
                console.log('📅 Current date after:', currentDate.toDateString());
                updateDateDisplay();
                loadSchedule();
                startAutoRefresh(); // Restart auto-refresh for new date
            });
            
            document.getElementById('nextDay').addEventListener('click', () => {
                console.log('➡️ Next day clicked');
                console.log('📅 Current date before:', currentDate.toDateString());
                // Create new date to avoid timezone issues with setDate
                currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() + 1);
                console.log('📅 Current date after:', currentDate.toDateString());
                updateDateDisplay();
                loadSchedule();
                startAutoRefresh(); // Restart auto-refresh for new date
            });
            
            // Set up refresh button
            document.getElementById('refreshSchedule').addEventListener('click', () => {
                loadSchedule();
            });
            
            // Set up toggle taken doses button
            document.getElementById('toggleTaken').addEventListener('click', () => {
                console.log('🔘 Toggle button clicked');
                console.log('👁️ Previous showTakenDoses value:', showTakenDoses);
                
                showTakenDoses = !showTakenDoses;
                console.log('👁️ New showTakenDoses value:', showTakenDoses);
                
                updateToggleButton();
                console.log('🔄 Loading schedule with showTakenDoses:', showTakenDoses);
                loadSchedule();
            });
            
            // Add force refresh functionality (double-click refresh button)
            let refreshClickCount = 0;
            let refreshTimeout;
            document.getElementById('refreshSchedule').addEventListener('click', () => {
                refreshClickCount++;
                clearTimeout(refreshTimeout);
                
                refreshTimeout = setTimeout(() => {
                    if (refreshClickCount === 1) {
                        // Single click - normal refresh
                        loadSchedule();
                    } else if (refreshClickCount >= 2) {
                        // Double click - force refresh by clearing cache
                        forceRefreshSchedule();
                    }
                    refreshClickCount = 0;
                }, 300);
            });
            
            // Set up dropdown functionality
            setupDateDropdown();
            
            // Auto-refresh when page becomes visible (e.g., when returning from dose verification)
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    // Check if we might be returning from verification
                    const wasHidden = document.hidden;
                    
                    // Check if language has changed while page was hidden
                    if (window.i18n) {
                        const currentLang = window.i18n.getCurrentLanguage();
                        const savedLang = localStorage.getItem('language') || 'en';
                        if (currentLang !== savedLang) {
                            console.log('🔄 Language changed while page was hidden, refreshing content...');
                            setTimeout(() => {
                                refreshAllContent();
                            }, 100);
                        }
                    }
                    
                    loadSchedule().then(() => {
                        // Show helpful notification for users returning from verification
                        if (wasHidden) {
                            setTimeout(() => {
                                if (!showTakenDoses) {
                                    showNotification(window.i18n ? window.i18n.t('schedule.completedDosesHidden') : 'Completed doses are hidden by default. Click "Show Taken" to see them.', 'info');
                                }
                            }, 500);
                        }
                    });
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
            
            // Start auto-refresh
            startAutoRefresh();
            
            // Language change is now handled by the event listener and page load check
            // No need for periodic interval checking
        });
        
        function startAutoRefresh() {
            // Only auto-refresh for today's schedule
            const today = new Date();
            const todayLocal = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const isToday = currentDate.toDateString() === todayLocal.toDateString();
            console.log('🔄 Starting auto-refresh, isToday:', isToday, 'currentDate:', currentDate.toDateString());
            stopAutoRefresh(); // Clear any existing interval
            
            if (isToday) {
                autoRefreshInterval = setInterval(() => {
                    loadSchedule();
                }, 60000); // Refresh every minute
                updateStatusIndicator(true);
            } else {
                updateStatusIndicator(false);
            }
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            updateStatusIndicator(false);
        }
        
        function updateStatusIndicator(isActive) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const updateTime = document.getElementById('updateTime');
            
            if (isActive) {
                indicator.classList.remove('hidden');
                statusText.textContent = showTakenDoses ? (window.i18n ? window.i18n.t('schedule.showingAllDoses') : 'Showing all doses (auto-updating)') : (window.i18n ? window.i18n.t('schedule.hidingCompletedDoses') : 'Hiding completed doses (auto-updating)');
                updateTime.textContent = (window.i18n ? window.i18n.t('schedule.lastUpdated') : 'Last updated') + ': ' + new Date().toLocaleTimeString();
            } else {
                indicator.classList.add('hidden');
            }
        }

        function updateToggleButton() {
            const button = document.getElementById('toggleTaken');
            const buttonText = document.getElementById('toggleTakenText');
            
            if (showTakenDoses) {
                button.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
                button.classList.remove('text-gray-600', 'border-gray-200');
                button.setAttribute('title', window.i18n ? window.i18n.t('schedule.hideTaken') : 'Hide completed doses');
                buttonText.textContent = window.i18n ? window.i18n.t('schedule.hideTaken') : 'Hide Taken';
            } else {
                button.classList.remove('bg-green-100', 'text-green-700', 'border-green-200');
                button.classList.add('text-gray-600', 'border-gray-200');
                button.setAttribute('title', window.i18n ? window.i18n.t('schedule.showTaken') : 'Show completed doses');
                buttonText.textContent = window.i18n ? window.i18n.t('schedule.showTaken') : 'Show Taken';
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 z-50 max-w-sm bg-white border rounded-lg shadow-lg p-4 transition-all duration-300 transform translate-x-full`;
            
            // Set color based on type
            const colors = {
                success: 'border-green-200 bg-green-50',
                info: 'border-blue-200 bg-blue-50',
                warning: 'border-yellow-200 bg-yellow-50'
            };
            notification.className += ` ${colors[type] || colors.info}`;
            
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        ${type === 'success' ? 
                            '<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' :
                            '<svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                        }
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium ${type === 'success' ? 'text-green-800' : 'text-blue-800'}">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 text-gray-400 hover:text-gray-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);
        }

        function setupDateDropdown() {
            const datePicker = document.getElementById('datePicker');
            const dateDropdown = document.getElementById('dateDropdown');
            
            // Toggle dropdown on button click
            datePicker.addEventListener('click', function(e) {
                e.stopPropagation();
                dateDropdown.classList.toggle('hidden');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!datePicker.contains(e.target) && !dateDropdown.contains(e.target)) {
                    dateDropdown.classList.add('hidden');
                }
            });
            
            // Handle dropdown item clicks
            const dropdownItems = dateDropdown.querySelectorAll('button');
            dropdownItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const text = this.querySelector('span').textContent;
                    handleDateSelection(text);
                    dateDropdown.classList.add('hidden');
                });
            });
        }

        function handleDateSelection(selection) {
            const today = new Date();
            const todayLocal = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            
            // Get the current language's translations for comparison
            const todayText = window.i18n ? window.i18n.t('time.today') : 'Today';
            const yesterdayText = window.i18n ? window.i18n.t('time.yesterday') : 'Yesterday';
            const tomorrowText = window.i18n ? window.i18n.t('time.tomorrow') : 'Tomorrow';
            const thisWeekText = window.i18n ? window.i18n.t('time.thisWeek') : 'This week';
            const nextWeekText = window.i18n ? window.i18n.t('time.nextWeek') : 'Next week';
            
            switch(selection) {
                case todayText:
                case 'Today': // Fallback for English
                    currentDate = new Date(todayLocal);
                    break;
                case yesterdayText:
                case 'Yesterday': // Fallback for English
                    currentDate = new Date(todayLocal.getFullYear(), todayLocal.getMonth(), todayLocal.getDate() - 1);
                    break;
                case tomorrowText:
                case 'Tomorrow': // Fallback for English
                    currentDate = new Date(todayLocal.getFullYear(), todayLocal.getMonth(), todayLocal.getDate() + 1);
                    break;
                case thisWeekText:
                case 'This week': // Fallback for English
                    // Go to start of current week (Sunday)
                    currentDate = new Date(todayLocal.getFullYear(), todayLocal.getMonth(), todayLocal.getDate() - todayLocal.getDay());
                    break;
                case nextWeekText:
                case 'Next week': // Fallback for English
                    // Go to start of next week (Sunday)
                    currentDate = new Date(todayLocal.getFullYear(), todayLocal.getMonth(), todayLocal.getDate() - todayLocal.getDay() + 7);
                    break;
            }
            
            updateDateDisplay();
            loadSchedule();
            startAutoRefresh(); // Restart auto-refresh for new date
        }

        function updateDateDisplay() {
            const today = new Date();
            const todayLocal = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const isToday = currentDate.toDateString() === todayLocal.toDateString();
            
            if (isToday) {
                document.getElementById('currentDate').textContent = window.i18n ? window.i18n.t('time.today') : 'Today';
                document.getElementById('dateSubtitle').textContent = window.i18n ? window.i18n.t('schedule.yourSchedule') : 'Your medication schedule';
            } else {
                // Check if it's yesterday or tomorrow
                const yesterday = new Date(todayLocal.getFullYear(), todayLocal.getMonth(), todayLocal.getDate() - 1);
                const tomorrow = new Date(todayLocal.getFullYear(), todayLocal.getMonth(), todayLocal.getDate() + 1);
                
                if (currentDate.toDateString() === yesterday.toDateString()) {
                    document.getElementById('currentDate').textContent = window.i18n ? window.i18n.t('time.yesterday') : 'Yesterday';
                } else if (currentDate.toDateString() === tomorrow.toDateString()) {
                    document.getElementById('currentDate').textContent = window.i18n ? window.i18n.t('time.tomorrow') : 'Tomorrow';
                } else {
                    // Format the date in the user's language
                    document.getElementById('currentDate').textContent = formatDateInUserLanguage(currentDate);
                }
                document.getElementById('dateSubtitle').textContent = window.i18n ? window.i18n.t('schedule.yourSchedule') : 'Medication schedule';
            }
        }

        // Format date in user's language
        function formatDateInUserLanguage(date) {
            if (!window.i18n) {
                // Fallback to English
                const options = { weekday: 'long', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }
            
            const weekday = date.getDay();
            const month = date.getMonth();
            const day = date.getDate();
            
            // Get weekday name in user's language
            const weekdays = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const weekdayName = window.i18n.t(`time.weekdays.${weekdays[weekday]}`);
            
            // Get month name in user's language
            const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
            const monthName = window.i18n.t(`time.months.${months[month]}`);
            
            // Format: "Monday, January 15" or "星期一, 一月 15"
            return `${weekdayName}, ${monthName} ${day}`;
        }

        // Refresh all content when language changes
        function refreshAllContent() {
            console.log('🔄 Refreshing all content for new language...');
            
            try {
                // Update date display
                if (typeof updateDateDisplay === 'function') {
                    updateDateDisplay();
                }
                
                // Update toggle button text
                if (typeof updateToggleButton === 'function') {
                    updateToggleButton();
                }
                
                // Update notification UI
                if (typeof updateNotificationUI === 'function') {
                    updateNotificationUI();
                }
                
                // Reload schedule to refresh medication cards
                if (typeof loadSchedule === 'function') {
                    loadSchedule();
                }
                
                // Update refill reminders if they exist
                if (typeof loadRefillReminders === 'function') {
                    loadRefillReminders();
                }
                
                // Update any status indicators
                if (typeof updateStatusIndicator === 'function' && typeof showTakenDoses !== 'undefined') {
                    updateStatusIndicator(true);
                }
                
                console.log('✅ Content refresh complete');
            } catch (error) {
                console.error('❌ Error refreshing content:', error);
            }
        }

        async function loadSchedule() {
            // Prevent recursive loading
            if (isLoadingSchedule) {
                console.log('⚠️ Schedule already loading, skipping...');
                return null;
            }
            
            // Debounce rapid successive calls
            if (scheduleLoadTimeout) {
                clearTimeout(scheduleLoadTimeout);
            }
            
            return new Promise((resolve) => {
                scheduleLoadTimeout = setTimeout(async () => {
                    isLoadingSchedule = true;
                    showLoading();
                    
                    try {
                        // Convert local date to YYYY-MM-DD format for consistent backend communication
                        const year = currentDate.getFullYear();
                        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                        const day = String(currentDate.getDate()).padStart(2, '0');
                        const dateString = `${year}-${month}-${day}`;
                        
                        console.log('🔍 Loading schedule for date:', dateString);
                        console.log('👁️ Show taken doses:', showTakenDoses);
                        console.log('📅 Current date object:', currentDate);
                        
                        const response = await makeTimezoneAwareAPICall(API.getMedicationSchedule, dateString, showTakenDoses);
                        console.log('📡 Schedule response status:', response.status);
                        
                        const data = await response.json();
                        console.log('📊 Schedule data:', data);
                        
                        if (data.success) {
                            displaySchedule(data.schedule);
                            // Update status indicator timestamp
                            const updateTime = document.getElementById('updateTime');
                            if (updateTime) {
                                updateTime.textContent = (window.i18n ? window.i18n.t('schedule.lastUpdated') : 'Last updated') + ': ' + new Date().toLocaleTimeString();
                            }
                            // Track when schedule was updated
                            lastScheduleUpdate = Date.now();
                            resolve(data.schedule); // Return schedule data for further processing
                        } else {
                            console.error('Error loading schedule:', data.message);
                            displayEmptySchedule();
                            resolve(null);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        displayEmptySchedule();
                        resolve(null);
                    } finally {
                        hideLoading();
                        isLoadingSchedule = false;
                    }
                }, 100); // 100ms debounce
            });
        }

        function displaySchedule(schedule) {
            // Prevent recursive calls
            if (isUpdatingSchedule) {
                return;
            }
            
            isUpdatingSchedule = true;
            
            try {
                // Display morning medications
                const morningContainer = document.getElementById('morningMeds');
                if (schedule.morning && schedule.morning.length > 0) {
                    morningContainer.innerHTML = schedule.morning.map(med => createMedicationCard(med, 'morning')).join('');

                } else {
                    morningContainer.innerHTML = createEmptyState();

                }
                
                // Display afternoon medications
                const afternoonContainer = document.getElementById('afternoonMeds');
                if (schedule.afternoon && schedule.afternoon.length > 0) {
                    afternoonContainer.innerHTML = schedule.afternoon.map(med => createMedicationCard(med, 'afternoon')).join('');

                } else {
                    afternoonContainer.innerHTML = createEmptyState();

                }
                
                // Display evening medications
                const eveningContainer = document.getElementById('eveningMeds');
                if (schedule.evening && schedule.evening.length > 0) {
                    eveningContainer.innerHTML = schedule.evening.map(med => createMedicationCard(med, 'evening')).join('');

                } else {
                    eveningContainer.innerHTML = createEmptyState();

                }
                
                // Load refill reminders after displaying schedule (but don't trigger schedule reloads)
                if (typeof window.API_BASE !== 'undefined') {
                    loadRefillReminders();
                } else {
                    // Wait for API to be available
                    const waitForAPI = () => {
                        if (typeof window.API_BASE !== 'undefined') {
                            loadRefillReminders();
                        } else {
                            setTimeout(waitForAPI, 100);
                        }
                    };
                    waitForAPI();
                }
                
                // Auto-start reminder system if notifications are enabled
                if (Notification.permission === 'granted' && !reminderInterval) {
                    setTimeout(() => {
                        // Only start if not already running
                        if (!reminderInterval) {
                            startMedicationReminders();
                        }
                    }, 500); // Small delay to ensure everything is set up
                }
            } finally {
                // Always reset the flag
                isUpdatingSchedule = false;
            }
        }

        function createMedicationCard(medication, timeSlot) {
            const timeDisplay = medication.time || getDefaultTime(timeSlot);
            const status = medication.taken ? 'taken' : 'pending';
            const statusClass = medication.taken ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
            const statusText = medication.taken ? (window.i18n ? window.i18n.t('medication.taken') : 'Taken') : (window.i18n ? window.i18n.t('medication.pending') : 'Pending');
            
            return `
                <div class="bg-gray-50 rounded-xl p-4 mb-4 last:mb-0">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h4 class="font-semibold text-gray-900">${medication.name}</h4>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                                    ${statusText}
                                </span>
                            </div>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('schedule.dosage') : 'Dosage'}:</span> ${medication.dosage}</p>
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('schedule.time') : 'Time'}:</span> ${timeDisplay}</p>
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('schedule.schedule') : 'Schedule'}:</span> ${translateMedicationInstruction(medication.originalSchedule)}</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            <div class="text-sm text-gray-500">
                                ${medication.taken ? (window.i18n ? window.i18n.t('medication.verified') : '✓ Verified via camera') : (window.i18n ? window.i18n.t('schedule.useVerificationPage') : 'Use verification page to log dose')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createEmptyState() {
            return `
                <div class="text-center text-gray-500 py-8">
                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>${window.i18n ? window.i18n.t('schedule.noMedicationsScheduled') : 'No medications scheduled'}</p>
                </div>
            `;
        }

        function getDefaultTime(timeSlot) {
            if (window.i18n) {
                switch(timeSlot) {
                    case 'morning': return window.i18n.t('time.timeRanges.morning').split(' - ')[0];
                    case 'afternoon': return window.i18n.t('time.timeRanges.afternoon').split(' - ')[0];
                    case 'evening': return window.i18n.t('time.timeRanges.evening').split(' - ')[0];
                    default: return '';
                }
            } else {
                // Fallback to English
                switch(timeSlot) {
                    case 'morning': return '8:00 AM';
                    case 'afternoon': return '12:00 PM';
                    case 'evening': return '6:00 PM';
                    default: return '';
                }
            }
        }

        // Translate status values
        function translateStatus(status) {
            if (!window.i18n) return status;
            
            const statusKey = status.toLowerCase().replace('_', '');
            return window.i18n.t(`refillDashboard.statusValues.${statusKey}`) || status;
        }

        // Translate urgency values
        function translateUrgency(urgency) {
            if (!window.i18n) return urgency;
            
            const urgencyKey = urgency.toLowerCase();
            return window.i18n.t(`refillDashboard.urgencyValues.${urgencyKey}`) || urgency;
        }

        // Translate dynamic backend messages
        function translateDynamicMessage(message) {
            if (!window.i18n || !message) return message;
            
            console.log('🔄 Translating dynamic message:', message);
            
            // Handle "Refill for {medication} is due in {days} days" pattern
            const refillDuePattern = /Refill for (.+) is due in (\d+) days?/i;
            const refillDueMatch = message.match(refillDuePattern);
            
            if (refillDueMatch) {
                const medication = refillDueMatch[1];
                const days = refillDueMatch[2];
                const translated = window.i18n.t('refillDashboard.refillForMedicationDueInDays', { medication, days });
                console.log('✅ Translated refill due message:', translated);
                return translated;
            }
            
            // Handle "Refill for {medication} is due tomorrow" pattern
            const refillDueTomorrowPattern = /Refill for (.+) is due tomorrow/i;
            const refillDueTomorrowMatch = message.match(refillDueTomorrowPattern);
            
            if (refillDueTomorrowMatch) {
                const medication = refillDueTomorrowMatch[1];
                const translated = window.i18n.t('refillDashboard.refillForMedicationDueTomorrow', { medication });
                console.log('✅ Translated refill due tomorrow message:', translated);
                return translated;
            }
            
            // Handle "supply is good" pattern
            if (message.toLowerCase().includes('supply is good')) {
                const daysMatch = message.match(/(\d+) days? remaining/);
                if (daysMatch) {
                    const days = daysMatch[1];
                    const translated = window.i18n.t('refillDashboard.supplyGoodMessage', { days });
                    console.log('✅ Translated supply good message:', translated);
                    return translated;
                }
            }
            
            // Handle "urgent refill" pattern
            if (message.toLowerCase().includes('urgent refill')) {
                const daysMatch = message.match(/(\d+) days?/);
                if (daysMatch) {
                    const days = daysMatch[1];
                    const translated = window.i18n.t('refillDashboard.urgentRefillDueInDays', { days });
                    console.log('✅ Translated urgent refill message:', translated);
                    return translated;
                }
            }
            
            // Handle "final reminder" pattern
            if (message.toLowerCase().includes('final reminder')) {
                const translated = window.i18n.t('refillDashboard.finalReminderDueTomorrow');
                console.log('✅ Translated final reminder message:', translated);
                return translated;
            }
            
            console.log('⚠️ No translation pattern found for:', message);
            return message;
        }

        // Smart medication instruction translator
        function translateMedicationInstruction(instruction) {
            if (!window.i18n) return instruction;
            
            const lowerInstruction = instruction.toLowerCase();
            
            // Extract count and frequency patterns
            let count = 1;
            let plural = '';
            let frequency = 'daily';
            let unit = '';
            
            // Parse count (e.g., "1", "2", "1/2")
            const countMatch = lowerInstruction.match(/(\d+(?:\/\d+)?)/);
            if (countMatch) {
                count = countMatch[1];
                // Handle fractions
                if (count.includes('/')) {
                    const [num, denom] = count.split('/');
                    count = `${num}/${denom}`;
                }
                plural = count === '1' ? '' : 's';
            }
            
            // Parse frequency patterns
            if (lowerInstruction.includes('twice daily') || lowerInstruction.includes('twice a day')) {
                frequency = 'twiceDaily';
            } else if (lowerInstruction.includes('three times daily') || lowerInstruction.includes('three times a day')) {
                frequency = 'threeTimesDaily';
            } else if (lowerInstruction.includes('every 4 hours')) {
                frequency = 'every4Hours';
            } else if (lowerInstruction.includes('every 6 hours')) {
                frequency = 'every6Hours';
            } else if (lowerInstruction.includes('every 8 hours')) {
                frequency = 'every8Hours';
            } else if (lowerInstruction.includes('every 12 hours')) {
                frequency = 'every12Hours';
            } else if (lowerInstruction.includes('weekly')) {
                frequency = 'weekly';
            } else if (lowerInstruction.includes('monthly')) {
                frequency = 'monthly';
            } else if (lowerInstruction.includes('as needed')) {
                frequency = 'asNeeded';
            } else if (lowerInstruction.includes('before meals')) {
                frequency = 'beforeMeals';
            } else if (lowerInstruction.includes('after meals')) {
                frequency = 'afterMeals';
            } else if (lowerInstruction.includes('with food')) {
                frequency = 'withFood';
            } else if (lowerInstruction.includes('on empty stomach')) {
                frequency = 'onEmptyStomach';
            }
            
            // Determine medication type and get appropriate translation
            let translationKey = 'takeTablet'; // default
            
            if (lowerInstruction.includes('capsule')) {
                translationKey = 'takeCapsule';
            } else if (lowerInstruction.includes('liquid') || lowerInstruction.includes('ml') || lowerInstruction.includes('teaspoon')) {
                translationKey = 'takeLiquid';
                unit = lowerInstruction.match(/(\d+(?:\.\d+)?)\s*(ml|teaspoon|tablespoon)/i)?.[2] || 'ml';
            } else if (lowerInstruction.includes('injection')) {
                translationKey = 'takeInjection';
            } else if (lowerInstruction.includes('inhaler')) {
                translationKey = 'takeInhaler';
            } else if (lowerInstruction.includes('drop')) {
                translationKey = 'takeDrops';
            } else if (lowerInstruction.includes('patch')) {
                translationKey = 'takePatch';
            } else if (lowerInstruction.includes('cream') || lowerInstruction.includes('ointment')) {
                translationKey = 'takeCream';
                unit = lowerInstruction.match(/(\d+(?:\.\d+)?)\s*(g|gram|mg|ml)/i)?.[2] || 'g';
            } else if (lowerInstruction.includes('suppository')) {
                translationKey = 'takeSuppository';
            }
            
            // Get the frequency translation
            const frequencyText = window.i18n.t(`schedule.medicationInstructions.frequency.${frequency}`);
            
            // Get the main instruction translation and interpolate
            let translatedInstruction = window.i18n.t(`schedule.medicationInstructions.${translationKey}`, {
                count: count,
                plural: plural,
                frequency: frequencyText,
                unit: unit
            });
            
            return translatedInstruction;
        }

        // Format date for display (used by refill reminders)
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                // Use our i18n date formatting if available, otherwise fall back to browser locale
                if (window.i18n) {
                    return formatDateInUserLanguage(date);
                }
                return date.toLocaleDateString();
            } catch (error) {
                return 'Invalid Date';
            }
        }

        // Get the current date being viewed in the schedule (YYYY-MM-DD format)
        function getCurrentDateString() {
            // Get the current date from the schedule page
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function displayEmptySchedule() {
            document.getElementById('morningMeds').innerHTML = createEmptyState();
            document.getElementById('afternoonMeds').innerHTML = createEmptyState();
            document.getElementById('eveningMeds').innerHTML = createEmptyState();
        }

        // Load refill reminders for the schedule calendar
        async function loadRefillReminders() {
            try {
                const response = await fetch(`${window.API_BASE}/dashboard/refills`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Use upcomingReminders instead of filtering medications
                    if (data.upcomingReminders && data.upcomingReminders.length > 0) {
                        displayRefillReminders(data.upcomingReminders);
                    } else {
                        // Fallback to medications if no specific reminders
                        displayRefillRemindersFromMedications(data.medications);
                    }
                } else {
                    displayEmptyRefillReminders();
                }
            } catch (error) {
                displayEmptyRefillReminders();
            }
        }

                // Display refill reminders in the schedule calendar (from upcomingReminders)
        function displayRefillReminders(reminders) {
            const container = document.getElementById('refillReminders');
            
            if (!reminders || reminders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-green-600 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-lg font-medium mb-2">${window.i18n ? window.i18n.t('schedule.refillReminders.allGood') : 'All good!'}</p>
                        <p class="text-sm text-green-500">${window.i18n ? window.i18n.t('schedule.refillReminders.noRefillsNeeded') : 'No refills needed right now'}</p>
                    </div>
                `;
                return;
            }
            
            // Filter reminders to only show those due on the current date being viewed
            const currentDateString = getCurrentDateString();
            
            const todaysReminders = reminders.filter(reminder => {
                const reminderDate = reminder.reminder_date;
                // Extract just the date part from the timestamp (YYYY-MM-DD)
                const reminderDateOnly = reminderDate.split('T')[0];
                return reminderDateOnly === currentDateString;
            });
            
            if (todaysReminders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <p class="text-lg font-medium mb-2">${window.i18n ? window.i18n.t('schedule.noRefillReminders') : 'No refill reminders today'}</p>
                        <p class="text-sm text-gray-400">${window.i18n ? window.i18n.t('schedule.checkOtherDates') : 'Check other dates for upcoming refill reminders'}</p>
                    </div>
                `;
                return;
            }
            
            // Display only today's reminders
            container.innerHTML = todaysReminders.map(reminder => createReminderCard(reminder)).join('');
        }

        // Fallback function to display reminders from medications data
        function displayRefillRemindersFromMedications(medications) {
            const container = document.getElementById('refillReminders');
            
            // Filter medications that need attention (low supply, overdue, due soon)
            const needsAttention = medications.filter(med => 
                med.refillStatus && (
                    med.refillStatus.status === 'overdue' || 
                    med.refillStatus.status === 'due_soon' || 
                    med.refillStatus.isLowSupply
                )
            );
            
            if (needsAttention.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-green-600 py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-lg font-medium mb-2">${window.i18n ? window.i18n.t('schedule.refillReminders.allGood') : 'All good!'}</p>
                        <p class="text-sm text-green-500">${window.i18n ? window.i18n.t('schedule.refillReminders.noRefillsNeeded') : 'No refills needed right now'}</p>
                    </div>
                `;
                return;
            }
            
            // Display medications that need attention
            container.innerHTML = needsAttention.map(med => createRefillReminderCard(med)).join('');
        }

        // Create a reminder card for the schedule calendar (from upcomingReminders data)
        function createReminderCard(reminder) {
            // Determine colors based on reminder type
            let borderColor = 'border-red-400';
            let statusColors = 'bg-yellow-100 text-yellow-800';
            
            if (reminder.reminder_type === 'low_supply') {
                borderColor = 'border-orange-400';
                statusColors = 'bg-orange-100 text-orange-800';
            } else if (reminder.reminder_type === 'refill_expiring') {
                borderColor = 'border-purple-400';
                statusColors = 'bg-purple-100 text-purple-800';
            }
            
            return `
                <div class="bg-gray-50 rounded-xl p-4 mb-4 last:mb-0 border-l-4 ${borderColor}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h4 class="font-semibold text-gray-900">${reminder.medication_name || 'Medication'}</h4>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColors}">
                                    ${window.i18n ? window.i18n.t(`schedule.reminderTypes.${reminder.reminder_type}`) : reminder.reminder_type.replace('_', ' ').toUpperCase()}
                                </span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    ${window.i18n ? window.i18n.t(`schedule.reminderStatus.${reminder.status}`) : reminder.status}
                                </span>
                            </div>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('schedule.refillReminders.reminderDate') : 'Reminder Date:'}</span> ${formatDate(reminder.reminder_date)}</p>
                                <p class="text-red-600 font-medium">${translateDynamicMessage(reminder.message) || 'No message'}</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            <button onclick="window.location.href='manage-medications.html'" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-3 rounded-lg font-medium transition-colors">
                                ${window.i18n ? window.i18n.t('schedule.refillReminders.manage') : 'Manage'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Create a refill reminder card for the schedule calendar (from medications data)
        function createRefillReminderCard(medication) {
            const status = medication.refillStatus.status;
            const urgency = medication.refillStatus.urgency;
            
            // Determine colors based on status and urgency
            let statusColors = 'bg-gray-100 text-gray-800';
            let urgencyColors = 'bg-gray-100 text-gray-800';
            
            if (status === 'overdue') {
                statusColors = 'bg-red-100 text-red-800';
            } else if (status === 'due_soon') {
                statusColors = 'bg-orange-100 text-orange-800';
            }
            
            if (urgency === 'critical') {
                urgencyColors = 'bg-red-100 text-red-800';
            } else if (urgency === 'high') {
                urgencyColors = 'bg-orange-100 text-orange-800';
            } else if (urgency === 'medium') {
                urgencyColors = 'bg-yellow-100 text-yellow-800';
            }
            
            return `
                <div class="bg-gray-50 rounded-xl p-4 mb-4 last:mb-0 border-l-4 border-red-400">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h4 class="font-semibold text-gray-900">${medication.name}</h4>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColors}">
                                    ${translateStatus(status)}
                                </span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${urgencyColors}">
                                    ${translateUrgency(urgency)}
                                </span>
                            </div>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('schedule.daysUntilRefill') : 'Days Until Refill'}:</span> ${medication.refillStatus.daysUntilRefill}</p>
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('schedule.supplyRemaining') : 'Supply Remaining'}:</span> ${medication.refillStatus.daysOfSupplyRemaining} ${window.i18n ? window.i18n.t('schedule.days') : 'days'}</p>
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('schedule.refillsLeft') : 'Refills Left'}:</span> ${medication.refillStatus.refillsRemaining}</p>
                                <p class="text-red-600 font-medium">${translateDynamicMessage(medication.refillStatus.message)}</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            <button onclick="window.location.href='manage-medications.html'" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg font-medium transition-colors">
                                ${window.i18n ? window.i18n.t('schedule.manage') : 'Manage'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Display empty state for refill reminders
        function displayEmptyRefillReminders() {
            const container = document.getElementById('refillReminders');
            container.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                    <p>${window.i18n ? window.i18n.t('schedule.refillReminders.unableToLoad') : 'Unable to load refill reminders'}</p>
                </div>
            `;
        }



        async function forceRefreshSchedule() {
            showLoading();
            
            try {
    
                
                // First, warm the cache to force regeneration
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const day = String(currentDate.getDate()).padStart(2, '0');
                const dateString = `${year}-${month}-${day}`;
                const warmResponse = await fetch(`${window.API_BASE}/schedule/warm-cache`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: 2,
                        startDate: dateString,
                        endDate: dateString
                    })
                });
                
                if (warmResponse.ok) {
        
                }
                
                // Then load the fresh schedule
                await loadSchedule();
                
            } catch (error) {
                                        console.error('Error force refreshing schedule:', error);
                // Fall back to normal refresh
                await loadSchedule();
            } finally {
                hideLoading();
            }
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        // Simple Browser Notifications
        function initializeNotifications() {
            updateNotificationUI();
            setupNotificationButtons();
        }

        function updateNotificationUI() {
            const statusElement = document.getElementById('notificationStatus');
            const enableButton = document.getElementById('enableNotifications');
            const icon = document.getElementById('notificationIcon');
            
            if (!statusElement) return;
            
            const permissionStatus = Notification.permission;
            
            switch (permissionStatus) {
                case 'granted':
                    statusElement.textContent = window.i18n ? window.i18n.t('schedule.notificationsText') : 'Notifications enabled! You\'ll receive medication reminders.';
                    enableButton.classList.add('hidden');
                    icon.className = 'w-3 h-3 rounded-full bg-green-500';
                    break;
                case 'denied':
                    statusElement.textContent = window.i18n ? window.i18n.t('schedule.notificationsBlocked') : 'Notifications blocked. Please enable in browser settings.';
                    enableButton.classList.add('hidden');
                    icon.className = 'w-3 h-3 rounded-full bg-red-500';
                    break;
                case 'default':
                    statusElement.textContent = window.i18n ? window.i18n.t('schedule.notificationsText') : 'Click "Enable" to get medication reminders';
                    enableButton.classList.remove('hidden');
                    icon.className = 'w-3 h-3 rounded-full bg-yellow-500';
                    break;
            }
        }

        function setupNotificationButtons() {
            const enableButton = document.getElementById('enableNotifications');
            
            if (enableButton) {
                enableButton.addEventListener('click', async () => {
                    try {
                        enableButton.textContent = 'Enabling...';
                        enableButton.disabled = true;
                        
                        // Always try to start reminders, regardless of current permission
                        if (Notification.permission === 'granted') {
                            // If already granted, just restart the system
                            startMedicationReminders();
                            showNotification('Reminder system restarted! You\'ll receive medication reminders.', 'success');
                        } else {
                            // If not granted, request permission first
                            const permission = await Notification.requestPermission();
                            
                            if (permission === 'granted') {
                                startMedicationReminders();
                                showNotification('Notifications enabled! You\'ll now receive medication reminders.', 'success');
                            } else {
                                showNotification('Notification permission denied. Please enable in browser settings.', 'warning');
                            }
                        }
                        
                        updateNotificationUI();
                    } catch (error) {
                        console.error('Error enabling notifications:', error);
                        showNotification('Error enabling notifications. Please try again.', 'warning');
                    } finally {
                        enableButton.textContent = 'Enable';
                        enableButton.disabled = false;
                    }
                });
            }
            



        }

        // Functional medication reminder system
        let currentSchedule = null;
        let reminderInterval = null;

        function startMedicationReminders() {
            if (Notification.permission !== 'granted') {
                return;
            }
            
            // Prevent multiple instances from running
            if (reminderInterval) {
                stopMedicationReminders();
            }
            
            // Load current schedule first, then start checking
            loadScheduleForReminders().then(() => {
                if (currentSchedule) {
                    // Check every 10 seconds for very precise medication reminders
                    reminderInterval = setInterval(() => {
                        checkAndShowReminders();
                    }, 10000); // Check every 10 seconds for maximum precision
                }
            }).catch(error => {
                console.error('Error starting medication reminders:', error);
            });
        }

        function stopMedicationReminders() {
            if (reminderInterval) {
                clearInterval(reminderInterval);
                reminderInterval = null;
            }
        }

        // Function to check if current schedule is still valid
        function isScheduleValid() {
            if (!currentSchedule || !lastScheduleUpdate) return false;
            
            // Consider schedule valid for 5 minutes
            const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
            return lastScheduleUpdate > fiveMinutesAgo;
        }

        async function loadScheduleForReminders() {
            try {
                // If we already have a valid schedule, use it
                if (isScheduleValid()) {
                    return currentSchedule;
                }
                
                // Use the existing loadSchedule function but wait for it to complete
                const schedule = await loadSchedule();
                
                if (schedule && (schedule.morning || schedule.afternoon || schedule.evening)) {
                    currentSchedule = schedule;
                    lastScheduleUpdate = Date.now();
                    return schedule;
                } else {
                    currentSchedule = null;
                    return null;
                }
            } catch (error) {
                console.error('Error loading schedule for reminders:', error);
                currentSchedule = null;
                return null;
            }
        }

        function checkAndShowReminders() {
            if (!currentSchedule || Notification.permission !== 'granted') {
                if (!currentSchedule) {
                    loadScheduleForReminders();
                }
                return;
            }
            
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // Check every minute for exact medication times
            checkExactMedicationTimes(currentHour, currentMinute);
        }

        function checkExactMedicationTimes(currentHour, currentMinute) {
            if (!currentSchedule) return;
            
            // Check all time slots for medications with exact times
            ['morning', 'afternoon', 'evening'].forEach(timeSlot => {
                if (!currentSchedule[timeSlot] || currentSchedule[timeSlot].length === 0) return;
                
                currentSchedule[timeSlot].forEach(medication => {
                    if (medication.time) {
                        // Parse the medication time (e.g., "3:34 PM")
                        const medTime = parseMedicationTime(medication.time);
                        if (medTime && isTimeToRemind(medTime, currentHour, currentMinute)) {
                            showMedicationReminder(timeSlot, [medication]);
                        }
                    }
                });
            });
        }

        function parseMedicationTime(timeString) {
            try {
                if (!timeString) return null;
                
                // Handle formats like "3:34 PM", "15:34", "3:34"
                let time = timeString.toLowerCase().trim();
                
                // Convert 12-hour to 24-hour format
                if (time.includes('pm') && !time.includes('12')) {
                    const [hour, minute] = time.replace('pm', '').split(':');
                    return { hour: parseInt(hour) + 12, minute: parseInt(minute) };
                } else if (time.includes('am') && time.includes('12')) {
                    const [hour, minute] = time.replace('am', '').split(':');
                    return { hour: 0, minute: parseInt(minute) };
                } else if (time.includes('am')) {
                    const [hour, minute] = time.replace('am', '').split(':');
                    return { hour: parseInt(hour), minute: parseInt(minute) };
                } else if (time.includes('pm') && time.includes('12')) {
                    const [hour, minute] = time.replace('pm', '').split(':');
                    return { hour: 12, minute: parseInt(minute) };
                } else {
                    // Assume 24-hour format
                    const [hour, minute] = time.split(':');
                    return { hour: parseInt(hour), minute: parseInt(minute) };
                }
            } catch (error) {
                console.error('Error parsing medication time:', timeString, error);
                return null;
            }
        }

        function isTimeToRemind(medTime, currentHour, currentMinute) {
            if (!medTime) return false;
            
            // Show reminder within 1 minute of scheduled time for more precision
            const timeDiff = Math.abs(medTime.minute - currentMinute);
            const isExactHour = medTime.hour === currentHour;
            const isWithin1Minute = timeDiff <= 1; // 1 minute tolerance
            
            return isExactHour && isWithin1Minute;
        }

        function showMedicationReminder(timeSlot, medications) {
            if (Notification.permission !== 'granted' || !medications || medications.length === 0) {
                return;
            }
            
            // Create a unique tag for each specific medication per day
            const now = new Date();
            const today = now.toDateString();
            
            // Create unique tags for each medication to prevent duplicates per day
            medications.forEach(medication => {
                const medName = medication.name.replace(/\s+/g, '-').toLowerCase();
                const tag = `medication-${medName}-${today}`;
                
                // Check if we already showed this specific medication today
                if (localStorage.getItem(tag)) {
                    return; // Skip this specific medication
                }
                
                // Get medication details
                const medNames = medication.name;
                const title = 'Medication Reminder';
                const body = `Time to take ${medNames}!`;
                
                try {
                    // Show the notification
                    const notification = new Notification(title, {
                        body: body,
                        icon: '/public/vite.svg',
                        tag: tag,
                        requireInteraction: false
                    });
                    
                    // Mark this specific medication as shown today
                    localStorage.setItem(tag, 'true');
                    
                    // Also show an in-app notification
                    showNotification(`Medication reminder: ${medNames}`, 'success');
                    
                } catch (error) {
                    console.error('Error showing notification:', error);
                    // Fallback to in-app notification
                    showNotification(`Medication reminder: ${medNames}`, 'success');
                }
            });
        }

        // Refresh schedule for reminders when page becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && Notification.permission === 'granted') {
                loadScheduleForReminders();
            }
        });

        // Also refresh when schedule is manually loaded
        const originalLoadSchedule = window.loadSchedule;
        if (originalLoadSchedule) {
            window.loadSchedule = async function(...args) {
                const result = await originalLoadSchedule.apply(this, args);
                if (Notification.permission === 'granted' && result) {
                    currentSchedule = result;
                }
                return result;
            };
        }


















    </script>
    
    <!-- Auth and API Scripts -->
    <script src="api-utils.js"></script>
    <script src="auth.js"></script>
    <script src="auth-guard.js"></script>
    <!-- Internationalization Script -->
    <script type="module" src="i18n.js"></script>

</body>
</html> 