<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="refillDashboard.title">Refill Dashboard - MediHelper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='index.html'" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h1 class="text-xl font-bold text-gray-900" data-i18n="refillDashboard.title">Refill Dashboard</h1>
                </div>
                <div class="flex space-x-2">
                    <button onclick="window.location.href='add-medication.html'" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-i18n="refillDashboard.addMedication">
                        + Add Medication
                    </button>
                    <button onclick="window.location.href='manage-medications.html'" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors" data-i18n="refillDashboard.manageAll">
                        Manage All
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Page Header with Greeting -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2" data-i18n="refillDashboard.greeting">Hi there</h2>
            <p class="text-gray-600" data-i18n="refillDashboard.description">Monitor your medication refills and manage reminders</p>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600" data-i18n="refillDashboard.summaryCards.totalMedications">Total Medications</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalMedications">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600" data-i18n="refillDashboard.summaryCards.lowSupply">Low Supply</p>
                        <p class="text-2xl font-bold text-gray-900" id="lowSupplyCount">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-red-100 rounded-lg">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600" data-i18n="refillDashboard.summaryCards.overdue">Overdue</p>
                        <p class="text-2xl font-bold text-gray-900" id="overdueCount">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4 19h6v-6H4v6zM4 5h6V4a1 1 0 00-1-1H5a1 1 0 00-1 1v1zM4 12h6v-1H4v1z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600" data-i18n="refillDashboard.summaryCards.dueSoon">Due Soon</p>
                        <p class="text-2xl font-bold text-gray-900" id="dueSoonCount">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Tabs -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-8">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6" aria-label="Tabs">
                    <button onclick="showTab('medications')" class="tab-button border-b-2 border-primary-500 text-primary-600 py-4 px-1 text-sm font-medium" data-tab="medications" data-i18n="refillDashboard.tabs.medications">
                        Medications & Refills
                    </button>
                    <button onclick="showTab('reminders')" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-4 px-1 text-sm font-medium" data-tab="reminders" data-i18n="refillDashboard.tabs.reminders">
                        Upcoming Reminders
                    </button>
                    <button onclick="showTab('calculations')" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-4 px-1 text-sm font-medium" data-tab="calculations" data-i18n="refillDashboard.tabs.calculations">
                        Calculation Details
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Medications Tab -->
                <div id="medicationsTab" class="tab-content">
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-2" data-i18n="refillDashboard.medicationsTab.title">Medications with Refill Data</h3>
                        <p class="text-sm text-gray-600" data-i18n="refillDashboard.medicationsTab.description">View detailed refill status for each medication</p>
                    </div>
                    <div id="medicationsList" class="space-y-4">
                        <!-- Medications will be loaded here -->
                    </div>
                </div>

                <!-- Reminders Tab -->
                <div id="remindersTab" class="tab-content hidden">
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-2" data-i18n="refillDashboard.remindersTab.title">Upcoming Refill Reminders</h3>
                        <p class="text-sm text-gray-600" data-i18n="refillDashboard.remindersTab.description">Manage your refill reminders and notifications</p>
                    </div>
                    <div id="remindersList" class="space-y-4">
                        <!-- Reminders will be loaded here -->
                    </div>
                </div>

                <!-- Calculations Tab -->
                <div id="calculationsTab" class="tab-content hidden">
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-2" data-i18n="refillDashboard.calculationsTab.title">Refill Calculation Details</h3>
                        <p class="text-sm text-gray-600" data-i18n="refillDashboard.calculationsTab.description">Compare pharmacy estimates with schedule-aware calculations</p>
                    </div>
                    <div id="calculationsList" class="space-y-4">
                        <!-- Calculation details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mb-4"></div>
                <p class="text-gray-700" data-i18n="refillDashboard.loading">Loading refill data...</p>
            </div>
        </div>
    </main>

    <script>
        let currentTab = 'medications';
        let dashboardData = null;

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            if (typeof authGuard !== 'undefined') {
                authGuard.checkAuth();
            }
            
            // Periodic language check (every 5 seconds)
            setInterval(() => {
                if (window.i18n) {
                    const currentLang = window.i18n.getCurrentLanguage();
                    const savedLang = localStorage.getItem('userLanguage') || 'en';
                    if (currentLang !== savedLang) {
                        console.log('🔄 Language preference changed, refreshing content...');
                        refreshAllContent();
                    }
                }
            }, 5000);

            // Initialize i18n with retry mechanism
            const initializeI18n = () => {
                if (window.i18n) {
                    console.log('🔄 Initializing i18n on refill dashboard...');
                    window.i18n.updatePage();
                    
                    // Listen for language changes and refresh content
                    window.addEventListener('languageChanged', function() {
                        console.log('🔄 Language changed on refill dashboard, refreshing content...');
                        refreshAllContent();
                        refreshOpenModals();
                    });
                    
                    // Check if language has changed since page load and refresh if needed
                    const currentLang = window.i18n.getCurrentLanguage();
                    const savedLang = localStorage.getItem('userLanguage') || 'en';
                    console.log('🔄 Language check - Current:', currentLang, 'Saved:', savedLang);
                    if (currentLang !== savedLang) {
                        console.log('🔄 Language preference changed, refreshing content...');
                        setTimeout(() => {
                            refreshAllContent();
                        }, 100);
                    }
                    
                    // Load greeting after i18n is initialized
                    loadGreeting();
                    
                    // Also check if we need to refresh based on saved language preference
                    const savedLanguage = localStorage.getItem('userLanguage');
                    if (savedLanguage && savedLanguage !== currentLang) {
                        console.log('🔄 Detected saved language preference:', savedLanguage, 'refreshing...');
                        setTimeout(() => {
                            refreshAllContent();
                        }, 200);
                    }
                } else {
                    console.log('⚠️ i18n not available, waiting...');
                    setTimeout(initializeI18n, 100);
                }
            };
            
            // Start i18n initialization
            initializeI18n();
            
            // Wait for API to be available before loading dashboard data
            const waitForAPI = () => {
                if (typeof window.API_BASE !== 'undefined') {
                    loadDashboardData();
                } else {
                    setTimeout(waitForAPI, 100);
                }
            };
            waitForAPI();
            
            // Also check language when page becomes visible (e.g., user returns from another tab)
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && window.i18n) {
                    console.log('🔄 Page became visible, checking language...');
                    const currentLang = window.i18n.getCurrentLanguage();
                    const savedLang = localStorage.getItem('userLanguage') || 'en';
                    if (currentLang !== savedLang) {
                        console.log('🔄 Language changed while page was hidden, refreshing...');
                        setTimeout(() => {
                            refreshAllContent();
                        }, 100);
                    }
                }
            });
            
            // Immediate language check after a short delay
            setTimeout(() => {
                if (window.i18n) {
                    console.log('🔄 Immediate language check after page load...');
                    const currentLang = window.i18n.getCurrentLanguage();
                    const savedLang = localStorage.getItem('userLanguage') || 'en';
                    console.log('🔄 Immediate check - Current:', currentLang, 'Saved:', savedLang);
                    if (currentLang !== savedLang) {
                        console.log('🔄 Language mismatch detected, refreshing...');
                        refreshAllContent();
                    }
                }
            }, 500);
        });

        function loadGreeting() {
            const greetingElement = document.querySelector('[data-i18n="refillDashboard.greeting"]');
            if (!greetingElement) return;
            
            if (window.i18n) {
                greetingElement.textContent = window.i18n.t('refillDashboard.greeting');
            } else {
                const hour = new Date().getHours();
                let greeting = 'Hi there';
                
                if (hour < 12) {
                    greeting = 'Good morning';
                } else if (hour < 17) {
                    greeting = 'Good afternoon';
                } else {
                    greeting = 'Good evening';
                }
                
                greetingElement.textContent = greeting;
            }
        }

        async function loadDashboardData() {
            // Debug: Check if loading element exists
            const loadingElement = document.getElementById('loadingState');
            console.log('Loading element found:', loadingElement ? 'YES' : 'NO');
            
            showLoading();
            
            try {
                // First check if user is authenticated
                console.log('Checking authentication status...');
                const authResponse = await fetch(`${window.API_BASE}/auth/user`, {
                    credentials: 'include'
                });
                
                if (!authResponse.ok) {
                    throw new Error(`Authentication failed: HTTP ${authResponse.status}`);
                }
                
                const authData = await authResponse.json();
                if (!authData.success) {
                    throw new Error('User not authenticated. Please log in.');
                }
                
                console.log('User authenticated:', authData.user.name);
                
                // Now load dashboard data
                console.log('Loading dashboard data from:', `${window.API_BASE}/dashboard/refills`);
                
                const response = await fetch(`${window.API_BASE}/dashboard/refills`, {
                    credentials: 'include'
                });
                
                console.log('Response status:', response.status, response.statusText);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    // Try to get the response text to see what's being returned
                    const responseText = await response.text();
                    console.error('Response text:', responseText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                console.log('Response is OK, attempting to parse JSON...');
                
                // Get the response text first to debug
                const responseText = await response.text();
                console.log('Raw response text:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('Successfully parsed JSON:', data);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    console.error('Response text that failed to parse:', responseText);
                    throw new Error(`Failed to parse JSON response: ${parseError.message}`);
                }
                
                if (data.success) {
                    console.log('Data loaded successfully, updating UI...');
                    console.log('🔍 Full API response:', data);
                    console.log('🔍 Medications array:', data.medications);
                    console.log('🔍 First medication structure:', data.medications[0]);
                    
                    dashboardData = data;
                    updateSummaryCards(data.summary);
                    displayMedications(data.medications);
                    displayReminders(data.upcomingReminders);
                    displayCalculations(data.medications);
                    console.log('UI updated successfully');
                    
                    // After loading data, check if we need to refresh language
                    if (window.i18n) {
                        const currentLang = window.i18n.getCurrentLanguage();
                        const savedLang = localStorage.getItem('userLanguage') || 'en';
                        if (currentLang !== savedLang) {
                            console.log('🔄 Language mismatch after data load, refreshing...');
                            setTimeout(() => {
                                window.i18n.updatePage();
                                refreshDynamicContent();
                            }, 100);
                        }
                    }
                } else {
                    console.error('Failed to load dashboard data:', data.message);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                
                // Show user-friendly error message
                const container = document.getElementById('medicationsList');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center text-red-500 py-12">
                            <svg class="w-16 h-16 mx-auto mb-4 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <p class="text-lg font-medium mb-2">${window.i18n ? window.i18n.t('refillDashboard.error.title') : 'Error loading dashboard data'}</p>
                            <p class="text-sm text-red-400 mb-4">${error.message}</p>
                            <button onclick="loadDashboardData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                ${window.i18n ? window.i18n.t('refillDashboard.error.tryAgain') : 'Try Again'}
                            </button>
                        </div>
                    `;
                }
            } finally {
                hideLoading();
            }
        }

        function updateSummaryCards(summary) {
            document.getElementById('totalMedications').textContent = summary.totalMedications;
            document.getElementById('lowSupplyCount').textContent = summary.lowSupplyCount;
            document.getElementById('overdueCount').textContent = summary.overdueCount;
            document.getElementById('dueSoonCount').textContent = summary.dueSoonCount;
        }

        function displayMedications(medications) {
            const container = document.getElementById('medicationsList');
            
            console.log('🔍 displayMedications called with:', medications);
            if (medications.length > 0) {
                console.log('🔍 First medication data:', medications[0]);
                console.log('🔍 First medication schedule:', medications[0].schedule);
                console.log('🔍 All available fields:', Object.keys(medications[0]));
                
                // Check for schedule-related fields
                const scheduleFields = Object.keys(medications[0]).filter(key => 
                    key.toLowerCase().includes('schedule') || 
                    key.toLowerCase().includes('instruction') ||
                    key.toLowerCase().includes('dosage')
                );
                console.log('🔍 Schedule-related fields found:', scheduleFields);
                
                // Check if schedule is nested
                if (medications[0].medication) {
                    console.log('🔍 Nested medication object:', medications[0].medication);
                    console.log('🔍 Nested medication schedule:', medications[0].medication.schedule);
                }
                
                console.log('🔍 Medication object structure:', JSON.stringify(medications[0], null, 2));
            }
            
            if (medications.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                        <p class="text-lg font-medium mb-2">${window.i18n ? window.i18n.t('refillDashboard.medicationsTab.noMedications') : 'No medications with refill data'}</p>
                        <p class="text-sm text-gray-400 mb-4">${window.i18n ? window.i18n.t('refillDashboard.medicationsTab.noMedicationsDescription') : 'Add medications with pharmacy labels to see refill information'}</p>
                        <button onclick="window.location.href='add-medication.html'" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            ${window.i18n ? window.i18n.t('refillDashboard.medicationsTab.addMedication') : 'Add Medication'}
                        </button>
                    </div>
                `;
                return;
            }

            const html = medications.map(medication => {
                try {
                    console.log('🔍 Processing medication:', medication.name);
                    console.log('🔍 Medication schedule:', medication.schedule);
                    
                    return `
                        <div class="bg-gray-50 rounded-lg border border-gray-200 p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-3">
                                        <h3 class="text-lg font-semibold text-gray-900">${medication.name}</h3>
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusBadgeColor(medication.refillStatus.status)}">${translateStatus(medication.refillStatus.status)}</span>
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getUrgencyBadgeColor(medication.refillStatus.urgency)}">${translateUrgency(medication.refillStatus.urgency)}</span>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
                                        <div><span class="font-medium text-gray-600">${window.i18n ? window.i18n.t('refillDashboard.medicationCard.daysUntilRefill') : 'Days Until Refill'}:</span><br><span class="text-gray-900">${medication.refillStatus.daysUntilRefill}</span></div>
                                        <div><span class="font-medium text-gray-600">${window.i18n ? window.i18n.t('refillDashboard.medicationCard.supplyRemaining') : 'Supply Remaining'}:</span><br><span class="text-gray-900">${medication.refillStatus.daysOfSupplyRemaining} ${window.i18n ? window.i18n.t('common.days') : 'days'}</span></div>
                                        <div><span class="font-medium text-gray-600">${window.i18n ? window.i18n.t('refillDashboard.medicationCard.refillDate') : 'Refill Date'}:</span><br><span class="text-gray-900">${formatDate(medication.refillStatus.refillDate)}</span></div>
                                        <div><span class="font-medium text-gray-600">${window.i18n ? window.i18n.t('refillDashboard.medicationCard.refillsLeft') : 'Refills Left'}:</span><br><span class="text-gray-900">${medication.refillStatus.refillsRemaining}</span></div>
                                    </div>
                                    
                                    <div class="text-sm text-gray-600 mb-4">
                                        <p><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.medicationCard.schedule') : 'Schedule'}:</span> ${(() => {
                                            const original = medication.schedule;
                                            const translated = translateMedicationInstruction(medication.schedule);
                                            console.log('🔍 Schedule translation debug:');
                                            console.log('  - Original:', original);
                                            console.log('  - Translated:', translated);
                                            console.log('  - Will display:', translated || 'No schedule');
                                            return translated || 'No schedule';
                                        })()}</p>
                                        <p><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.medicationCard.message') : 'Message'}:</span> ${translateDynamicMessage(medication.refillStatus.message)}</p>
                                    </div>
                                    
                                    <div class="flex space-x-2">
                                        <button onclick="viewRefillStatus(${medication.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors">
                                            ${window.i18n ? window.i18n.t('refillDashboard.medicationCard.viewDetails') : 'View Details'}
                                        </button>
                                        <button onclick="manageRefillReminders(${medication.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors">
                                            ${window.i18n ? window.i18n.t('refillDashboard.medicationCard.manageReminders') : 'Manage Reminders'}
                                        </button>
                                        <button onclick="viewRefillCalculation(${medication.id})" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors">
                                            ${window.i18n ? window.i18n.t('refillDashboard.medicationCard.calculation') : 'Calculation'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('❌ Error processing medication:', medication.name, error);
                    return `
                        <div class="bg-red-50 rounded-lg border border-red-200 p-6">
                            <p class="text-red-600">Error displaying medication: ${medication.name}</p>
                            <p class="text-red-500 text-sm">${error.message}</p>
                        </div>
                    `;
                }
            }).join('');
            
            container.innerHTML = html;
        }

        function displayReminders(reminders) {
            const container = document.getElementById('remindersList');
            
            if (reminders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4 19h6v-6H4v6zM4 5h6V4a1 1 0 00-1-1H5a1 1 0 00-1 1v1zM4 12h6v-1H4v1z"></path>
                        </svg>
                        <p class="text-lg font-medium mb-2">${window.i18n ? window.i18n.t('refillDashboard.remindersTab.noReminders') : 'No upcoming reminders'}</p>
                        <p class="text-sm text-gray-400">${window.i18n ? window.i18n.t('refillDashboard.remindersTab.noRemindersDescription') : 'Reminders will appear here when you have medications due for refills'}</p>
                    </div>
                `;
                return;
            }

            const html = reminders.map(reminder => `
                <div class="bg-gray-50 rounded-lg border border-gray-200 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h4 class="font-medium text-gray-900">${reminder.medication_name}</h4>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${getReminderTypeColor(reminder.reminder_type)}">${translateReminderType(reminder.reminder_type)}</span>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${getReminderStatusColor(reminder.status)}">${translateReminderStatus(reminder.status)}</span>
                            </div>
                            <div class="text-sm text-gray-600">
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.reminderCard.date') : 'Date'}:</span> ${formatDate(reminder.reminder_date)}</p>
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.reminderCard.message') : 'Message'}:</span> ${translateDynamicMessage(reminder.message) || (window.i18n ? window.i18n.t('refillDashboard.reminderCard.noMessage') : 'No message')}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="updateReminderStatus(${reminder.id}, 'dismissed')" class="text-xs text-gray-500 hover:text-gray-700">
                                ${window.i18n ? window.i18n.t('refillDashboard.reminderCard.dismiss') : 'Dismiss'}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function displayCalculations(medications) {
            const container = document.getElementById('calculationsList');
            
            const medicationsWithSchedule = medications.filter(m => m.schedule && m.quantity);
            
            if (medicationsWithSchedule.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <p class="text-lg font-medium mb-2">${window.i18n ? window.i18n.t('refillDashboard.calculationsTab.noCalculations') : 'No calculation comparisons available'}</p>
                        <p class="text-sm text-gray-400">${window.i18n ? window.i18n.t('refillDashboard.calculationsTab.noCalculationsDescription') : 'Medications with schedules and quantities will show calculation comparisons'}</p>
                    </div>
                `;
                return;
            }

            const html = medicationsWithSchedule.map(medication => `
                <div class="bg-gray-50 rounded-lg border border-gray-200 p-6">
                    <div class="flex items-start justify-between mb-4">
                        <h4 class="text-lg font-medium text-gray-900">${medication.name}</h4>
                        <button onclick="viewRefillCalculation(${medication.id})" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-md text-xs font-medium transition-colors">
                            ${window.i18n ? window.i18n.t('refillDashboard.calculationCard.viewDetails') : 'View Details'}
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="p-3 bg-gray-100 rounded-lg">
                            <h5 class="font-medium text-gray-900 mb-2">${window.i18n ? window.i18n.t('refillDashboard.calculationCard.scheduleInformation') : 'Schedule Information'}</h5>
                            <p><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.medicationCard.schedule') : 'Schedule'}:</span> ${translateMedicationInstruction(medication.schedule)}</p>
                            <p><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.calculationCard.quantity') : 'Quantity'}:</span> ${medication.quantity} ${window.i18n ? window.i18n.t('common.units') : 'units'}</p>
                            <p><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.calculationCard.pharmacyDaysSupply') : 'Pharmacy Days Supply'}:</span> ${medication.days_supply} ${window.i18n ? window.i18n.t('common.days') : 'days'}</p>
                        </div>
                        
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <h5 class="font-medium text-blue-900 mb-2">${window.i18n ? window.i18n.t('refillDashboard.calculationCard.enhancedCalculation') : 'Enhanced Calculation'}</h5>
                            ${medication.enhancedCalculation ? `
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.calculationCard.method') : 'Method'}:</span> ${medication.enhancedCalculation.calculationMethod}</p>
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.calculationCard.consumptionRate') : 'Consumption Rate'}:</span> ${medication.enhancedCalculation.consumptionRate} ${window.i18n ? window.i18n.t('manageMedications.dosesPerDay') : 'doses/day'}</p>
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.calculationCard.actualDaysSupply') : 'Actual Days Supply'}:</span> ${medication.enhancedCalculation.actualDaysSupply} ${window.i18n ? window.i18n.t('common.days') : 'days'}</p>
                            ` : `<p class="text-blue-600">${window.i18n ? window.i18n.t('refillDashboard.calculationCard.clickToSeeCalculation') : 'Click "View Details" to see calculation'}</p>`}
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active state from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-primary-500', 'text-primary-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Activate selected tab button
            const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
            activeButton.classList.remove('border-transparent', 'text-gray-500');
            activeButton.classList.add('border-primary-500', 'text-primary-600');
            
            currentTab = tabName;
        }

        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString();
        }

        function getStatusBadgeColor(status) {
            const colors = {
                'good': 'bg-green-100 text-green-800',
                'low': 'bg-yellow-100 text-yellow-800',
                'overdue': 'bg-red-100 text-red-800',
                'due_soon': 'bg-orange-100 text-orange-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function getUrgencyBadgeColor(urgency) {
            const colors = {
                'low': 'bg-gray-100 text-gray-800',
                'medium': 'bg-yellow-100 text-yellow-800',
                'high': 'bg-red-100 text-red-800'
            };
            return colors[urgency] || 'bg-gray-100 text-gray-800';
        }

        function getReminderTypeColor(type) {
            const colors = {
                'refill_due': 'bg-red-100 text-red-800',
                'refill_expiring': 'bg-yellow-100 text-yellow-800',
                'low_supply': 'bg-orange-100 text-orange-800'
            };
            return colors[type] || 'bg-gray-100 text-gray-800';
        }

        function getReminderStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'sent': 'bg-green-100 text-green-800',
                'dismissed': 'bg-gray-100 text-gray-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        // Helper function to translate medication instructions
        function translateMedicationInstruction(instruction) {
            if (!window.i18n || !instruction) {
                console.log('🔍 translateMedicationInstruction: No i18n or instruction:', { hasI18n: !!window.i18n, instruction });
                return instruction;
            }
            
            console.log('🔍 translateMedicationInstruction called with:', instruction);
            console.log('🔍 Current language:', window.i18n.currentLanguage);
            
            // Check if it's a tablet instruction
            const tabletMatch = instruction.match(/Take (\d+(?:\.\d+)?) tablet(s?) by mouth (.+)/);
            console.log('🔍 Tablet match attempt:', tabletMatch);
            if (tabletMatch) {
                const quantity = tabletMatch[1];
                const plural = tabletMatch[2];
                const frequency = tabletMatch[3];
                console.log('🔍 Tablet match:', { quantity, plural, frequency });
                
                // Translate the frequency
                const translatedFrequency = translateFrequency(frequency);
                console.log('🔍 Translated frequency:', translatedFrequency);
                
                // Build the translated instruction
                const translated = window.i18n.t('refillDashboard.medicationInstructions.takeTablet', {
                    quantity: quantity,
                    plural: plural,
                    frequency: translatedFrequency
                });
                console.log('✅ Translated tablet instruction:', translated);
                return translated;
            }
            
            // Check if it's a capsule instruction
            const capsuleMatch = instruction.match(/Take (\d+(?:\.\d+)?) capsule(s?) (.+)/);
            console.log('🔍 Capsule match attempt:', capsuleMatch);
            if (capsuleMatch) {
                const quantity = capsuleMatch[1];
                const plural = capsuleMatch[2];
                const frequency = capsuleMatch[3];
                console.log('🔍 Capsule match:', { quantity, plural, frequency });
                
                const translatedFrequency = translateFrequency(frequency);
                const translated = window.i18n.t('refillDashboard.medicationInstructions.takeCapsule', {
                    quantity: quantity,
                    plural: plural,
                    frequency: translatedFrequency
                });
                console.log('✅ Translated capsule instruction:', translated);
                return translated;
            }
            
            // Check if it's a liquid instruction
            const liquidMatch = instruction.match(/Take (\d+(?:\.\d+)?) (.+) of liquid (.+)/);
            console.log('🔍 Liquid match attempt:', liquidMatch);
            if (liquidMatch) {
                const quantity = liquidMatch[1];
                const unit = liquidMatch[2];
                const frequency = liquidMatch[3];
                console.log('🔍 Liquid match:', { quantity, unit, frequency });
                
                const translatedFrequency = translateFrequency(frequency);
                const translated = window.i18n.t('refillDashboard.medicationInstructions.takeLiquid', {
                    quantity: quantity,
                    unit: unit,
                    frequency: translatedFrequency
                });
                console.log('✅ Translated liquid instruction:', translated);
                return translated;
            }
            
            console.log('⚠️ No translation pattern found for instruction:', instruction);
            console.log('⚠️ Available patterns: tablet, capsule, liquid');
            
            // Check if instruction is already in Chinese and needs reverse translation
            if (window.i18n.currentLanguage === 'zh') {
                console.log('🔍 Checking for reverse translation from Chinese');
                
                // Check if it's already a Chinese tablet instruction
                const chineseTabletMatch = instruction.match(/口服 (\d+(?:\.\d+)?) 片(.*?) (.+)/);
                console.log('🔍 Chinese tablet match attempt:', chineseTabletMatch);
                if (chineseTabletMatch) {
                    console.log('✅ Instruction already in Chinese, no translation needed');
                    return instruction;
                }
                
                // Check if it's already a Chinese capsule instruction
                const chineseCapsuleMatch = instruction.match(/服用 (\d+(?:\.\d+)?) 粒胶囊(.*?) (.+)/);
                console.log('🔍 Chinese capsule match attempt:', chineseCapsuleMatch);
                if (chineseCapsuleMatch) {
                    console.log('✅ Instruction already in Chinese, no translation needed');
                    return instruction;
                }
            }
            
            return instruction;
        }
        
        // Helper function to translate frequency text
        function translateFrequency(frequency) {
            if (!window.i18n) return frequency;
            
            console.log('🔍 translateFrequency called with:', frequency);
            
            // Check for common frequency patterns
            const frequencyPatterns = {
                'every day': 'daily',
                'twice daily': 'twiceDaily',
                'three times daily': 'threeTimesDaily',
                'every 4 hours': 'every4Hours',
                'every 6 hours': 'every6Hours',
                'every 8 hours': 'every8Hours',
                'every 12 hours': 'every12Hours',
                'weekly': 'weekly',
                'monthly': 'monthly',
                'as needed': 'asNeeded',
                'before meals': 'beforeMeals',
                'after meals': 'afterMeals',
                'with food': 'withFood',
                'on empty stomach': 'onEmptyStomach'
            };
            
            const normalizedFrequency = frequency.toLowerCase();
            const patternKey = frequencyPatterns[normalizedFrequency];
            
            if (patternKey) {
                const translated = window.i18n.t(`refillDashboard.frequency.${patternKey}`);
                console.log('✅ Frequency translation found:', translated);
                return translated;
            }
            
            console.log('⚠️ No frequency pattern found for:', frequency);
            return frequency;
        }

        // Helper function to translate dynamic backend messages
        function translateDynamicMessage(message) {
            if (!window.i18n || !message) {
                console.log('🔍 translateDynamicMessage: No i18n or message:', { hasI18n: !!window.i18n, message });
                return message;
            }
            
            console.log('🔍 translateDynamicMessage called with:', message);
            console.log('🔍 Current language:', window.i18n.currentLanguage);
            
            // Check if it's a supply good message
            const supplyGoodMatch = message.match(/(.+) supply is good \((\d+) days remaining\)/);
            if (supplyGoodMatch) {
                const medication = supplyGoodMatch[1];
                const days = supplyGoodMatch[2];
                console.log('🔍 Supply good match:', { medication, days });
                const translated = window.i18n.t('refillDashboard.dynamicMessages.supplyGood', { medication, days });
                console.log('✅ Translated supply good message:', translated);
                return translated;
            }
            
            // Check if it's an urgent refill message
            const urgentRefillMatch = message.match(/URGENT: Refill for (.+) is due in (\d+) days/);
            if (urgentRefillMatch) {
                const medication = urgentRefillMatch[1];
                const days = urgentRefillMatch[2];
                console.log('🔍 Urgent refill match:', { medication, days });
                const translated = window.i18n.t('refillDashboard.dynamicMessages.urgentRefill', { medication, days });
                console.log('✅ Translated urgent refill message:', translated);
                return translated;
            }
            
            // Check if it's a final reminder message
            const finalReminderMatch = message.match(/FINAL REMINDER: Refill for (.+) is due tomorrow/);
            if (finalReminderMatch) {
                const medication = finalReminderMatch[1];
                console.log('🔍 Final reminder match:', { medication });
                const translated = window.i18n.t('refillDashboard.dynamicMessages.finalReminder', { medication });
                console.log('✅ Translated final reminder message:', translated);
                return translated;
            }
            
            // Check if it's a refill due message
            const refillDueMatch = message.match(/refill due/);
            if (refillDueMatch) {
                console.log('🔍 Refill due match found');
                const translated = window.i18n.t('refillDashboard.dynamicMessages.refillDue');
                console.log('✅ Translated refill due message:', translated);
                return translated;
            }
            
            // Check if it's a refill due in days message
            const refillDueInDaysMatch = message.match(/due in (\d+) days/);
            if (refillDueInDaysMatch) {
                const days = refillDueInDaysMatch[1];
                console.log('🔍 Refill due in days match:', { days });
                const translated = window.i18n.t('refillDashboard.dynamicMessages.refillDueInDays', { days });
                console.log('✅ Translated refill due in days message:', translated);
                return translated;
            }
            
            console.log('⚠️ No translation pattern found for:', message);
            return message;
        }

        // Helper function to translate status text
        function translateStatus(status) {
            if (!window.i18n) {
                console.log('🔍 translateStatus: No i18n available');
                return status.replace('_', ' ').toUpperCase();
            }
            console.log('🔍 translateStatus called with:', status);
            const translated = window.i18n.t(`refillDashboard.statusValues.${status}`) || status.replace('_', ' ').toUpperCase();
            console.log('✅ Status translation result:', translated);
            return translated;
        }

        // Helper function to translate urgency text
        function translateUrgency(urgency) {
            if (!window.i18n) {
                console.log('🔍 translateUrgency: No i18n available');
                return urgency;
            }
            
            console.log('🔍 translateUrgency called with:', urgency);
            console.log('🔍 Current language:', window.i18n.currentLanguage);
            
            // Normalize the urgency value to lowercase for consistent matching
            const normalizedUrgency = urgency ? urgency.toLowerCase() : urgency;
            console.log('🔍 Normalized urgency:', normalizedUrgency);
            
            // Try to translate the urgency value
            let translated = window.i18n.t(`refillDashboard.urgencyValues.${normalizedUrgency}`);
            console.log('🔍 Translation attempt for', `refillDashboard.urgencyValues.${normalizedUrgency}:`, translated);
            
            if (translated && translated !== `refillDashboard.urgencyValues.${normalizedUrgency}`) {
                console.log('✅ Translation found:', translated);
                return translated;
            }
            
            // If no translation found, provide fallback translations
            const fallbackTranslations = {
                'none': window.i18n.t('refillDashboard.urgencyValues.none') || 'NONE',
                'low': window.i18n.t('refillDashboard.urgencyValues.low') || 'LOW',
                'medium': window.i18n.t('refillDashboard.urgencyValues.medium') || 'MEDIUM',
                'high': window.i18n.t('refillDashboard.urgencyValues.high') || 'HIGH'
            };
            
            console.log('🔍 Fallback translations:', fallbackTranslations);
            console.log('🔍 Looking for urgency:', normalizedUrgency, 'in fallbacks');
            
            const result = fallbackTranslations[normalizedUrgency] || urgency;
            console.log('🔍 Final result:', result);
            return result;
        }

        // Helper function to translate reminder type text
        function translateReminderType(type) {
            if (!window.i18n) return type.replace('_', ' ');
            return window.i18n.t(`refillDashboard.reminderTypeLabels.${type}`) || type.replace('_', ' ');
        }

        // Helper function to translate reminder status text
        function translateReminderStatus(status) {
            if (!window.i18n) return status;
            return window.i18n.t(`refillDashboard.statusLabels.${status}`) || status;
        }

        function showLoading() {
            const loadingElement = document.getElementById('loadingState');
            if (loadingElement) {
                loadingElement.classList.remove('hidden');
            } else {
                console.warn('Loading state element not found');
            }
        }

        function hideLoading() {
            const loadingElement = document.getElementById('loadingState');
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            } else {
                console.warn('Loading state element not found');
            }
        }

        // Refill management functions (same as in manage-medications.html)
        async function viewRefillStatus(medicationId) {
            try {
                showLoading();
                const response = await fetch(`${window.API_BASE}/medications/${medicationId}/refill-status`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showRefillStatusModal(data);
                } else {
                    alert('Error loading refill status: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading refill status:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function viewRefillCalculation(medicationId) {
            try {
                showLoading();
                const response = await fetch(`${window.API_BASE}/medications/${medicationId}/refill-calculation`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showRefillCalculationModal(data);
                } else {
                    alert('Error loading refill calculation: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading refill calculation:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function manageRefillReminders(medicationId) {
            try {
                showLoading();
                const response = await fetch(`${window.API_BASE}/refill-reminders?medication_id=${medicationId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showRefillRemindersModal(medicationId, data.reminders);
                } else {
                    alert('Error loading refill reminders: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading refill reminders:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function updateReminderStatus(reminderId, status) {
            try {
                const response = await fetch(`${window.API_BASE}/refill-reminders/${reminderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ status })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Close the modal first
                    const modal = document.querySelector('.fixed');
                    if (modal) {
                        modal.remove();
                    }
                    
                    // Show success message
                    alert('Reminder status updated successfully!');
                    
                    // Redirect to manage medications page
                    window.location.href = 'manage-medications.html';
                } else {
                    alert('Error updating reminder status: ' + data.message);
                }
            } catch (error) {
                console.error('Error updating reminder status:', error);
                alert('Error: ' + error.message);
            }
        }

        // Modal display functions (same as in manage-medications.html)
        function showRefillStatusModal(data) {
            console.log('🔍 showRefillStatusModal called with data:', data);
            console.log('🔍 Current language:', window.i18n ? window.i18n.currentLanguage : 'No i18n');
            console.log('🔍 Status:', data.refillStatus.status);
            console.log('🔍 Urgency:', data.refillStatus.urgency);
            console.log('🔍 Message:', data.refillStatus.message);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">${window.i18n ? window.i18n.t('refillDashboard.modals.refillStatus.title') : 'Refill Status'} - ${data.medication.name}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="p-4 rounded-lg ${getStatusColor(data.refillStatus.status)}">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-lg font-semibold">${translateStatus(data.refillStatus.status)}</span>
                                <span class="text-sm px-2 py-1 rounded-full ${getUrgencyColor(data.refillStatus.urgency)}">${translateUrgency(data.refillStatus.urgency)}</span>
                            </div>
                            <p class="text-sm">${translateDynamicMessage(data.refillStatus.message)}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.modals.refillStatus.daysUntilRefill') : 'Days Until Refill'}:</span> ${data.refillStatus.daysUntilRefill}</div>
                            <div><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.modals.refillStatus.daysOfSupplyRemaining') : 'Days of Supply Remaining'}:</span> ${data.refillStatus.daysOfSupplyRemaining}</div>
                            <div><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.modals.refillStatus.refillDate') : 'Refill Date'}:</span> ${formatDate(data.refillStatus.refillDate)}</div>
                            <div><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.modals.refillStatus.refillsRemaining') : 'Refills Remaining'}:</span> ${data.refillStatus.refillsRemaining}</div>
                        </div>
                        
                        ${data.calculationComparison ? `
                            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <h4 class="font-medium text-blue-900 mb-2">${window.i18n ? window.i18n.t('refillDashboard.modals.refillStatus.calculationComparison') : 'Calculation Comparison'}</h4>
                                <div class="text-sm text-blue-800">
                                    <p><strong>${window.i18n ? window.i18n.t('refillDashboard.modals.refillStatus.recommendation') : 'Recommendation'}:</strong> ${data.calculationComparison.recommendation}</p>
                                    <p><strong>${window.i18n ? window.i18n.t('refillDashboard.modals.refillStatus.difference') : 'Difference'}:</strong> ${data.calculationComparison.difference.days} days (${data.calculationComparison.difference.percentageChange}%)</p>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Debug: Log what translation keys were used
            console.log('🔍 Modal created with translation keys:');
            console.log('- Title:', window.i18n ? window.i18n.t('refillDashboard.modals.refillStatus.title') : 'Refill Status');
            console.log('- Days Until Refill:', window.i18n ? window.i18n.t('refillDashboard.modals.refillStatus.daysUntilRefill') : 'Days Until Refill');
            console.log('- Urgency translation:', translateUrgency(data.refillStatus.urgency));
        }

        function showRefillCalculationModal(data) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.title') : 'Refill Calculation Details'} - ${data.medication.name}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${data.comparison.comparison === 'available' ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                    <h4 class="font-medium text-gray-900 mb-3">${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.pharmacyEstimate') : 'Pharmacy Estimate (Basic)'}</h4>
                                    <div class="space-y-2 text-sm">
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.refillDate') : 'Refill Date'}:</span> ${data.comparison.basic.refillDate}</div>
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.daysUntil') : 'Days Until'}:</span> ${data.comparison.basic.daysUntil}</div>
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.daysSupply') : 'Days Supply'}:</span> ${data.comparison.basic.daysSupply}</div>
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.assumption') : 'Assumption'}:</span> ${data.comparison.basic.assumption}</div>
                                    </div>
                                </div>
                                
                                <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <h4 class="font-medium text-blue-900 mb-3">${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.enhancedCalculation') : 'Enhanced Calculation'}</h4>
                                    <div class="space-y-2 text-sm">
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.refillDate') : 'Refill Date'}:</span> ${data.comparison.enhanced.refillDate}</div>
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.daysUntil') : 'Days Until'}:</span> ${data.comparison.enhanced.daysUntil}</div>
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.daysSupply') : 'Days Supply'}:</span> ${data.comparison.enhanced.daysSupply}</div>
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.consumptionRate') : 'Consumption Rate'}:</span> ${data.comparison.enhanced.consumptionRate} ${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.dosesPerDay') : 'doses/day'}</div>
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.scheduleUsed') : 'Schedule Used'}:</span> ${translateMedicationInstruction(data.comparison.enhanced.assumption)}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                                <h4 class="font-medium text-green-900 mb-2">${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.analysis') : 'Analysis'}</h4>
                                <div class="text-sm text-green-800">
                                    <p><strong>${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.difference') : 'Difference'}:</strong> ${data.comparison.difference.days} days (${data.comparison.difference.percentageChange}%)</p>
                                    <p><strong>${window.i18n ? window.i18n.t('refillDashboard.modals.refillCalculation.recommendation') : 'Recommendation'}:</strong> ${data.comparison.recommendation}</p>
                                </div>
                            </div>
                        ` : `
                            <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                <p class="text-yellow-800">${data.comparison.message}</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showRefillRemindersModal(medicationId, reminders) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">${window.i18n ? window.i18n.t('refillDashboard.modals.refillReminders.title') : 'Refill Reminders'}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${reminders.length > 0 ? `
                            <div class="space-y-3">
                                ${reminders.map(reminder => `
                                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="font-medium text-gray-900">${reminder.medication_name}</div>
                                                <div class="text-sm text-gray-600">${translateReminderType(reminder.reminder_type)} - ${formatDate(reminder.reminder_date)}</div>
                                                <div class="text-sm text-gray-500">${translateDynamicMessage(reminder.message) || window.i18n.t('refillDashboard.modals.refillReminders.noMessage')}</div>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-xs px-2 py-1 rounded-full ${getReminderStatusColor(reminder.status)}">${translateReminderStatus(reminder.status)}</span>
                                                <button onclick="updateReminderStatus(${reminder.id}, 'dismissed')" class="text-xs text-gray-500 hover:text-gray-700">${window.i18n.t('refillDashboard.modals.refillReminders.dismiss')}</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center text-gray-500 py-8">
                                <p class="mb-4">${window.i18n ? window.i18n.t('refillDashboard.modals.refillReminders.noRemindersFound') : 'No refill reminders found for this medication.'}</p>
                                <button onclick="generateRefillReminders(${medicationId})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                    ${window.i18n ? window.i18n.t('refillDashboard.modals.refillReminders.generateReminders') : 'Generate Reminders'}
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function getStatusColor(status) {
            const colors = {
                'good': 'bg-green-100 border-green-200 text-green-800',
                'low': 'bg-yellow-100 border-yellow-200 text-yellow-800',
                'overdue': 'bg-red-100 border-red-200 text-red-800',
                'due_soon': 'bg-orange-100 border-orange-200 text-orange-800'
            };
            return colors[status] || 'bg-gray-100 border-gray-200 text-gray-800';
        }

        function getUrgencyColor(urgency) {
            const colors = {
                'low': 'bg-gray-100 text-gray-800',
                'medium': 'bg-yellow-100 text-yellow-800',
                'high': 'bg-red-100 text-red-800'
            };
            return colors[urgency] || 'bg-gray-100 text-gray-800';
        }

        async function generateRefillReminders(medicationId) {
            try {
                showLoading();
                const response = await fetch(`${window.API_BASE}/medications/${medicationId}/refill-reminders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({})
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Successfully generated ${data.reminders.length} refill reminders!`);
                    // Close modal and refresh dashboard
                    const modal = document.querySelector('.fixed');
                    if (modal) {
                        modal.remove();
                    }
                    loadDashboardData();
                } else {
                    alert('Error generating refill reminders: ' + data.message);
                }
            } catch (error) {
                console.error('Error generating refill reminders:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Function to refresh all content
        function refreshAllContent() {
            console.log('🔄 Refreshing all content...');
            refreshStaticContent();
            refreshDynamicContent();
        }

        // Function to refresh static content
        function refreshStaticContent() {
            console.log('🔄 Refreshing static content...');
            if (window.i18n && window.i18n.updatePage) {
                window.i18n.updatePage();
            }
        }

        // Function to refresh dynamic content
        function refreshDynamicContent() {
            console.log('🔄 Refreshing dynamic content...');
            if (dashboardData) {
                // Refresh summary cards
                updateSummaryCards(dashboardData.summary);
                
                // Refresh tab content based on current tab
                if (currentTab === 'medications') {
                    displayMedications(dashboardData.medications);
                } else if (currentTab === 'reminders') {
                    displayReminders(dashboardData.upcomingReminders);
                } else if (currentTab === 'calculations') {
                    displayCalculations(dashboardData.medications);
                }
                
                console.log('✅ Dynamic content refreshed on refill dashboard');
            }
        }

        // Function to refresh all open modals
        function refreshOpenModals() {
            console.log('🔄 refreshOpenModals called');
            
            // Find all open modals
            const openModals = document.querySelectorAll('.fixed');
            console.log('🔍 Found open modals:', openModals.length);
            
            if (openModals.length === 0) {
                console.log('ℹ️ No open modals found');
                return;
            }
            
            // Remove all open modals so they can be re-rendered with new language
            openModals.forEach((modal, index) => {
                console.log(`🗑️ Removing modal ${index + 1}`);
                modal.remove();
            });
            
            console.log('✅ All open modals removed, they will be re-rendered when needed');
        }

        // Language change listener
        window.addEventListener('languageChanged', () => {
            console.log('🔄 Language changed on refill dashboard, refreshing content...');
            refreshAllContent();
            refreshOpenModals();
        });
    </script>
    
    <!-- Auth and API Scripts -->
    <script src="api-utils.js"></script>
    <script src="auth.js"></script>
    <script src="auth-guard.js"></script>
    <script src="i18n.js"></script>
</body>
</html>
