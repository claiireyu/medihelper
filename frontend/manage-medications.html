<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Medications - MediHelper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Smooth transitions for manage medications page */
        * {
            transition: all 0.2s ease-out;
        }
        
        /* Page transitions */
        .page-transition {
            animation: pageFadeIn 0.4s ease-out;
        }
        
        /* Medication card transitions */
        .medication-card {
            transition: all 0.3s ease-out;
            transform: translateY(0);
        }
        
        .medication-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Modal transitions */
        .modal-overlay {
            backdrop-filter: blur(2px);
            background-color: rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease-out;
        }
        
        .modal-content {
            transition: all 0.3s ease-out;
            transform: scale(0.95);
            opacity: 0;
        }
        
        .modal-content.show {
            transform: scale(1);
            opacity: 1;
        }
        
        /* Loading state improvements */
        #loadingState {
            backdrop-filter: blur(2px);
            background-color: rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease-out;
        }
        
        /* Content animations */
        .content-fade-in {
            animation: contentFadeIn 0.5s ease-out;
        }
        
        @keyframes pageFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes contentFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='index.html'" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h1 class="text-xl font-bold text-gray-900" data-i18n="manageMedications.manageMedications">Manage Medications</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='add-medication.html'" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <span data-i18n="manageMedications.addNew">+ Add New</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 page-transition">
        
        <!-- Page Header with Greeting -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2" data-greeting data-i18n="manageMedications.hiThere">Hi there</h2>
            <p class="text-gray-600" data-i18n="manageMedications.manageYourMedicationsAndRefills">Manage your medications and refills</p>
        </div>
        
        <!-- Medications List -->
        <div id="medicationsList" class="space-y-4">
            <!-- Medications will be loaded here -->
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mb-4"></div>
                <p class="text-gray-700" data-i18n="manageMedications.loadingMedications">Loading medications...</p>
            </div>
        </div>

        <!-- Edit Medication Modal -->
        <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="manageMedications.editMedication">Edit Medication</h3>
                <form id="editForm" class="space-y-4">
                    <div>
                        <label for="editName" class="block text-sm font-medium text-gray-700 mb-2" data-i18n="manageMedications.medicationName">Medication Name</label>
                        <input type="text" id="editName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    
                    <div>
                        <label for="editDosage" class="block text-sm font-medium text-gray-700 mb-2" data-i18n="manageMedications.dosage">Dosage</label>
                        <input type="text" id="editDosage" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    
                    <div>
                        <label for="editSchedule" class="block text-sm font-medium text-gray-700 mb-2" data-i18n="manageMedications.schedule">Schedule</label>
                        <input type="text" id="editSchedule" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    
                    <div>
                        <label for="editSpecificTime" class="block text-sm font-medium text-gray-700 mb-2" data-i18n="manageMedications.specificTimeOptional">Specific Time (optional)</label>
                        <input type="time" id="editSpecificTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="submit" class="flex-1 bg-primary-600 hover:bg-primary-700 text-white py-2 rounded-lg font-medium transition-colors">
                            <span data-i18n="manageMedications.saveChanges">Save Changes</span>
                        </button>
                        <button type="button" onclick="closeEditModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                            <span data-i18n="manageMedications.cancel">Cancel</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Refill History Modal -->
        <div id="refillModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-96 overflow-y-auto">
                <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="manageMedications.refillHistory">Refill History</h3>
                <div id="refillHistory" class="space-y-3">
                    <!-- Refill history will be loaded here -->
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="closeRefillModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                        <span data-i18n="manageMedications.close">Close</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900" data-i18n="manageMedications.deleteMedication">Delete Medication</h3>
                        <p class="text-sm text-gray-600" data-i18n="manageMedications.actionCannotBeUndone">This action cannot be undone</p>
                    </div>
                </div>
                
                <p class="text-gray-700 mb-6">
                    <span data-i18n="manageMedications.deleteConfirmation">Are you sure you want to delete</span> <strong id="deleteMedicationName"></strong>? <span data-i18n="manageMedications.deleteConfirmationDetails">This will also remove all associated dose logs and history.</span>
                </p>
                
                <div class="flex space-x-3">
                    <button id="confirmDeleteBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-medium transition-colors">
                        <span data-i18n="manageMedications.yesDelete">Yes, Delete</span>
                    </button>
                    <button onclick="closeDeleteModal()" class="flex-1 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors py-2">
                        <span data-i18n="manageMedications.cancel">Cancel</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-around py-2">
                <button class="flex flex-col items-center py-2 px-3 text-gray-500 hover:text-gray-700" onclick="window.location.href='index.html'">
                    <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                    <span class="text-xs" data-i18n="navigation.home">Home</span>
                </button>
                <button class="flex flex-col items-center py-2 px-3 text-gray-500 hover:text-gray-700" onclick="window.location.href='schedule.html'">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span class="text-xs" data-i18n="navigation.schedule">Schedule</span>
                </button>
                <button class="flex flex-col items-center py-2 px-3 text-gray-500 hover:text-gray-700" onclick="window.location.href='verify.html'">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-xs" data-i18n="navigation.verify">Verify</span>
                </button>
                <button class="flex flex-col items-center py-2 px-3 text-gray-500 hover:text-gray-700" onclick="window.location.href='add-medication.html'">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span class="text-xs" data-i18n="navigation.add">Add</span>
                </button>
                <button class="flex flex-col items-center py-2 px-3 text-gray-500 hover:text-gray-700" onclick="window.location.href='history.html'">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <span class="text-xs" data-i18n="navigation.history">History</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Add bottom padding to account for fixed navigation -->
    <div class="h-20"></div>

    <script>
        let currentMedication = null;
        let currentMode = 'view';
        
        document.addEventListener('DOMContentLoaded', function() {
            const waitForAPI = () => {
                if (typeof window.API !== 'undefined') {
                    loadMedications();
                } else {
                    setTimeout(waitForAPI, 100);
                }
            };
            waitForAPI();
            
            checkI18nAndRefresh();
        });

        function translateMedicationInstruction(instruction) {
            if (!window.i18n || typeof window.i18n.t !== 'function') return instruction;
            
            const lowerInstruction = instruction.toLowerCase();
            
            try {
                if (lowerInstruction.includes('take') && lowerInstruction.includes('tablet') && lowerInstruction.includes('by mouth')) {
                    const match = instruction.match(/take (\d+) tablet(s)? by mouth (.+)/i);
                    if (match) {
                        const count = parseInt(match[1]);
                        const plural = count > 1 ? 's' : '';
                        const frequency = match[3];
                        
                        let translatedFrequency = frequency;
                        if (frequency.includes('every day')) {
                            translatedFrequency = window.i18n.t('schedule.medicationInstructions.frequency.daily') || 'every day';
                        } else if (frequency.includes('twice daily')) {
                            translatedFrequency = window.i18n.t('schedule.medicationInstructions.frequency.twiceDaily') || 'twice daily';
                        } else if (frequency.includes('three times daily')) {
                            translatedFrequency = window.i18n.t('schedule.medicationInstructions.frequency.threeTimesDaily') || 'three times daily';
                        }
                        
                        const translated = window.i18n.t('schedule.medicationInstructions.takeTablet', { 
                            count: count, 
                            plural: plural, 
                            frequency: translatedFrequency 
                        }) || instruction;
                        return translated;
                    }
                }
                
                if (lowerInstruction.includes('服用') && lowerInstruction.includes('片') && lowerInstruction.includes('每天')) {
                    const match = instruction.match(/服用(\d+)片(.+)/);
                    if (match) {
                        const count = parseInt(match[1]);
                        const plural = count > 1 ? 's' : '';
                        
                        const translated = window.i18n.t('schedule.medicationInstructions.takeTablet', { 
                            count: count, 
                            plural: plural, 
                            frequency: window.i18n.t('schedule.medicationInstructions.frequency.daily') || 'every day'
                        }) || instruction;
                        return translated;
                    }
                }
                
                let translatedInstruction = instruction;
                
                if (lowerInstruction.includes('take')) {
                    const takeTranslation = window.i18n.t('schedule.medicationInstructions.takeTablet');
                    if (takeTranslation && takeTranslation !== 'schedule.medicationInstructions.takeTablet') {
                        translatedInstruction = translatedInstruction.replace(/take/gi, takeTranslation.split('{')[0].trim());
                    }
                }
                if (lowerInstruction.includes('tablet')) {
                    const tabletTranslation = window.i18n.t('schedule.medicationInstructions.takeTablet');
                    if (tabletTranslation && tabletTranslation !== 'schedule.medicationInstructions.takeTablet') {
                        const tabletPart = tabletTranslation.split('tablet')[0].split('{')[2]?.split('}')[0] || 'tablet';
                        translatedInstruction = translatedInstruction.replace(/tablet/gi, tabletPart);
                    }
                }
                if (lowerInstruction.includes('by mouth')) {
                    const mouthTranslation = window.i18n.t('schedule.medicationInstructions.takeTablet');
                    if (mouthTranslation && mouthTranslation !== 'schedule.medicationInstructions.takeTablet') {
                        const mouthPart = mouthTranslation.split('mouth')[0].split('{')[3]?.split('}')[0] || 'by mouth';
                        translatedInstruction = translatedInstruction.replace(/by mouth/gi, mouthPart);
                    }
                }
                if (lowerInstruction.includes('every day')) {
                    const frequencyTranslation = window.i18n.t('schedule.medicationInstructions.frequency.daily');
                    if (frequencyTranslation && frequencyTranslation !== 'schedule.medicationInstructions.frequency.daily') {
                        translatedInstruction = translatedInstruction.replace(/every day/gi, frequencyTranslation);
                    }
                }
                
                return translatedInstruction;
            } catch (error) {
                return instruction;
            }
        }

        function checkI18nAndRefresh() {
            setTimeout(() => {
                if (window.i18n && typeof window.i18n.t === 'function') {
                    refreshDynamicContent();
                } else {
                    setTimeout(checkI18nAndRefresh, 100);
                }
            }, 200);
        }

        window.addEventListener('languageChanged', function() {
            if (window.i18n && typeof window.i18n.updatePage === 'function') {
                window.i18n.updatePage();
            } else {
                refreshStaticContent();
            }
            
            refreshDynamicContent();
        });
        
        if (window.i18n) {
            const currentLang = window.i18n.getCurrentLanguage();
            const savedLang = localStorage.getItem('language') || 'en';
            if (currentLang !== savedLang) {
                setTimeout(() => {
                    refreshStaticContent();
                    refreshDynamicContent();
                }, 100);
            }
        }

        function refreshStaticContent() {
            if (!window.i18n) return;
            
            const elements = document.querySelectorAll('[data-i18n]');
            
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (key) {
                    const translatedText = window.i18n.t(key);
                    if (translatedText && translatedText !== key) {
                        element.textContent = translatedText;
                    }
                }
            });
        }

        function refreshDynamicContent() {
            if (!window.i18n) return;
            
            loadMedications();
            
            refreshOpenModals();
        }
        
        function formatDateInUserLanguage(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                if (window.i18n && window.i18n.getCurrentLanguage() === 'zh') {
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                } else {
                    return date.toLocaleDateString('en-US', { 
                        month: 'numeric', 
                        day: 'numeric', 
                        year: 'numeric' 
                    });
                }
            } catch (error) {
                return dateString;
            }
        }

        function translateReminderMessage(message, medicationName) {
            if (!window.i18n || typeof window.i18n.t !== 'function') return message;
            
            try {
                if (message.includes('Refill for') && message.includes('is due in') && message.includes('days')) {
                    const match = message.match(/Refill for (.+) is due in (\d+) days/);
                    if (match) {
                        const medication = match[1];
                        const days = match[2];
                        return window.i18n.t('manageMedications.refillForMedicationDueInDays', { medication, days });
                    }
                }
                
                if (message.includes('Refill for') && message.includes('is due tomorrow')) {
                    const match = message.match(/Refill for (.+) is due tomorrow/);
                    if (match) {
                        const medication = match[1];
                        return window.i18n.t('manageMedications.refillForMedicationDueTomorrow', { medication });
                    }
                }
                
                if (message.startsWith('URGENT:') && message.includes('is due in') && message.includes('days')) {
                    const match = message.match(/URGENT: Refill for (.+) is due in (\d+) days/);
                    if (match) {
                        const medication = match[1];
                        const days = match[2];
                        return window.i18n.t('manageMedications.urgentRefillDueInDays', { medication, days });
                    }
                }
                
                if (message.startsWith('FINAL REMINDER:') && message.includes('is due tomorrow')) {
                    const match = message.match(/FINAL REMINDER: Refill for (.+) is due tomorrow/);
                    if (match) {
                        const medication = match[1];
                        return window.i18n.t('manageMedications.finalReminderDueTomorrow', { medication });
                    }
                }
                
                return message;
            } catch (error) {
                return message;
            }
        }

        function translateBackendMessage(message) {
            if (!window.i18n || typeof window.i18n.t !== 'function') return message;
            
            try {
                if (message.includes('supply is good') && message.includes('days remaining')) {
                    const match = message.match(/(.+) supply is good \((\d+) days remaining\)/);
                    if (match) {
                        const medication = match[1];
                        const days = match[2];
                        return window.i18n.t('manageMedications.supplyGoodMessage', { medication, days });
                    }
                }
                
                return message;
            } catch (error) {
                return message;
            }
        }

        function translateBackendValue(value, type) {
            if (!window.i18n || typeof window.i18n.t !== 'function') return value;
            
            try {
                if (type === 'status') {
                    const statusMap = {
                        'good': window.i18n.t('manageMedications.good'),
                        'low': window.i18n.t('manageMedications.low'),
                        'overdue': window.i18n.t('manageMedications.overdue'),
                        'due_soon': window.i18n.t('manageMedications.dueSoon')
                    };
                    return statusMap[value] || value;
                } else if (type === 'urgency') {
                    const urgencyMap = {
                        'none': window.i18n.t('manageMedications.none'),
                        'low': window.i18n.t('manageMedications.low'),
                        'medium': window.i18n.t('manageMedications.medium'),
                        'high': window.i18n.t('manageMedications.high')
                    };
                    return urgencyMap[value] || value;
                }
                return value;
            } catch (error) {
                return value;
            }
        }

        function refreshOpenModals() {
            const openModals = document.querySelectorAll('.fixed');
            if (openModals.length > 0) {
            }
        }

        async function loadMedications() {
            showLoading();
            
            try {
                            const response = await window.API.getMedications();
            const data = await response.json();
                
                if (data.success && data.medications.length > 0) {
                    displayMedications(data.medications);
                } else {
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error loading medications:', error);
                showErrorState();
            } finally {
                hideLoading();
            }
        }

        function displayMedications(medications) {
            const container = document.getElementById('medicationsList');
            
            const html = medications.map(medication => `
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h3 class="text-lg font-semibold text-gray-900">${medication.name}</h3>
                                ${medication.refill_of_id ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${window.i18n ? window.i18n.t('manageMedications.refill') : 'Refill'}</span>` : ''}
                                ${medication.extraction_used ? `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">${window.i18n ? window.i18n.t('manageMedications.aiExtracted') : '🤖 AI Extracted'}</span>` : `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">${window.i18n ? window.i18n.t('manageMedications.manualEntry') : '📝 Manual Entry'}</span>`}
                            </div>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.dosage') : 'Dosage'}:</span> ${medication.dosage || (window.i18n ? window.i18n.t('manageMedications.notSpecified') : 'Not specified')}</p>
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.schedule') : 'Schedule'}:</span> ${medication.schedule ? (window.i18n ? translateMedicationInstruction(medication.schedule) : medication.schedule) : (window.i18n ? window.i18n.t('manageMedications.notSpecified') : 'Not specified')}</p>
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.specificTime') : 'Time'}:</span> ${getTimeDisplay(medication)}</p>
                                <p><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.added') : 'Added'}:</span> ${new Date(medication.created_at).toLocaleDateString()}</p>
                                ${medication.extraction_used && medication.extraction_confidence ? `<p><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.aiConfidence') : 'AI Confidence'}:</span> <span class="capitalize">${window.i18n ? window.i18n.t(`manageMedications.confidence${medication.extraction_confidence.charAt(0).toUpperCase() + medication.extraction_confidence.slice(1)}`) : medication.extraction_confidence}</span></p>` : ''}
                            </div>
                            
                            ${hasRefillData(medication) ? `
                                <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <div class="flex items-center space-x-2 mb-3">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                                        </svg>
                                        <h4 class="font-medium text-blue-900">${window.i18n ? window.i18n.t('manageMedications.refillInformation') : 'Refill Information'}</h4>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        ${medication.date_filled ? `<div><span class="font-medium text-blue-800">${window.i18n ? window.i18n.t('manageMedications.dateFilled') : 'Date Filled'}:</span><br><span class="text-blue-700">${formatDate(medication.date_filled)}</span></div>` : ''}
                                        ${medication.quantity ? `<div><span class="font-medium text-blue-800">${window.i18n ? window.i18n.t('manageMedications.quantity') : 'Quantity'}:</span><br><span class="text-blue-700">${medication.quantity} units</span></div>` : ''}
                                        ${medication.days_supply ? `<div><span class="font-medium text-blue-800">${window.i18n ? window.i18n.t('manageMedications.daysSupply') : 'Days Supply'}:</span><br><span class="text-blue-700">${medication.days_supply} days</span></div>` : ''}
                                        ${medication.refills_remaining !== null ? `<div><span class="font-medium text-blue-800">${window.i18n ? window.i18n.t('manageMedications.refillsLeft') : 'Refills Left'}:</span><br><span class="text-blue-700">${medication.refills_remaining}</span></div>` : ''}
                                        ${medication.pharmacy_name ? `<div><span class="font-medium text-blue-800">${window.i18n ? window.i18n.t('manageMedications.pharmacy') : 'Pharmacy'}:</span><br><span class="text-blue-700">${medication.pharmacy_name}</span></div>` : ''}
                                        ${medication.refill_expiry_date ? `<div><span class="font-medium text-blue-800">${window.i18n ? window.i18n.t('manageMedications.expires') : 'Expires'}:</span><br><span class="text-blue-700">${formatDate(medication.refill_expiry_date)}</span></div>` : ''}
                                    </div>
                                    <div class="mt-3 flex space-x-2">
                                        <button onclick="viewRefillStatus(${medication.id})" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md transition-colors">
                                            ${window.i18n ? window.i18n.t('manageMedications.viewRefillStatus') : 'View Refill Status'}
                                        </button>
                                        <button onclick="viewRefillCalculation(${medication.id})" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded-md transition-colors">
                                            ${window.i18n ? window.i18n.t('manageMedications.calculationDetails') : 'Calculation Details'}
                                        </button>
                                        <button onclick="manageRefillReminders(${medication.id})" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded-md transition-colors">
                                            ${window.i18n ? window.i18n.t('manageMedications.manageReminders') : 'Manage Reminders'}
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button onclick="editMedication(${medication.id})" class="text-primary-600 hover:text-primary-700 text-sm font-medium">
                                ${window.i18n ? window.i18n.t('manageMedications.edit') : 'Edit'}
                            </button>
                            <button onclick="viewRefillHistory(${medication.id})" class="text-gray-600 hover:text-gray-700 text-sm font-medium">
                                ${window.i18n ? window.i18n.t('manageMedications.refillHistory') : 'Refill History'}
                            </button>
                            <button onclick="createRefill(${medication.id})" class="text-green-600 hover:text-green-700 text-sm font-medium">
                                ${getRefillButtonText(medication)}
                            </button>
                            <button onclick="confirmDeleteMedication(${medication.id}, '${medication.name.replace(/'/g, "\\'")}' )" class="text-red-600 hover:text-red-700 text-sm font-medium">
                                ${window.i18n ? window.i18n.t('manageMedications.delete') : 'Delete'}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function getTimeDisplay(medication) {
            if (medication.specific_time) {
                return medication.specific_time;
            } else if (medication.dose_type) {
                const timeMap = {
                    'morning': window.i18n ? window.i18n.t('time.timeSlots.morning') + ' (5 AM - 12 PM)' : 'Morning (5 AM - 12 PM)',
                    'afternoon': window.i18n ? window.i18n.t('time.timeSlots.afternoon') + ' (12 PM - 5 PM)' : 'Afternoon (12 PM - 5 PM)',
                    'evening': window.i18n ? window.i18n.t('time.timeSlots.evening') + ' (5 PM - 5 AM)' : 'Evening (5 PM - 5 AM)'
                };
                const result = timeMap[medication.dose_type] || medication.dose_type;
                return result;
            }
            return window.i18n ? window.i18n.t('manageMedications.notSpecified') : 'Not specified';
        }

        function hasRefillData(medication) {
            return medication.date_filled || medication.quantity || medication.days_supply || 
                   medication.refills_remaining !== null || medication.pharmacy_name;
        }

        function getRefillButtonText(medication) {
            if (!hasRefillData(medication)) {
                return window.i18n ? window.i18n.t('manageMedications.addRefillData') : 'Add Refill Data';
            }
            
            if (medication.refillStatus) {
                const status = medication.refillStatus.status;
                if (status === 'overdue') {
                    return window.i18n ? window.i18n.t('manageMedications.refillOverdue') : 'Refill Overdue';
                } else if (status === 'due_soon') {
                    return window.i18n ? window.i18n.t('manageMedications.refillDueSoon') : 'Refill Due Soon';
                } else if (medication.refillStatus.isLowSupply) {
                    return window.i18n ? window.i18n.t('manageMedications.lowSupply') : 'Low Supply';
                }
            }
            
            return window.i18n ? window.i18n.t('manageMedications.createRefill') : 'Create Refill';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString();
        }

        async function editMedication(medicationId) {
            try {
                const response = await window.API.getMedications();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const numericMedicationId = parseInt(medicationId);
                    
                    currentMedication = data.medications.find(med => med.id === numericMedicationId);
                    
                    if (currentMedication) {
                        document.getElementById('editName').value = currentMedication.name;
                        document.getElementById('editDosage').value = currentMedication.dosage || '';
                        document.getElementById('editSchedule').value = currentMedication.schedule || '';
                        document.getElementById('editSpecificTime').value = currentMedication.specific_time || '';
                        
                        document.getElementById('editModal').classList.remove('hidden');
                    } else {
                        alert('Medication not found');
                    }
                } else {
                    alert('Error loading medications: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Error loading medication details: ' + error.message);
            }
        }

        async function viewRefillHistory(medicationId) {
            try {
                const response = await window.API.getMedicationRefills(medicationId);
                const data = await response.json();
                
                if (data.success) {
                    displayRefillHistory(data.refills);
                    document.getElementById('refillModal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading refill history:', error);
                alert('Error loading refill history');
            }
        }

        function displayRefillHistory(refills) {
            const container = document.getElementById('refillHistory');
            
            if (refills.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center py-4">${window.i18n ? window.i18n.t('manageMedications.noRefillsFound') : 'No refills found'}</p>`;
                return;
            }
            
            const html = refills.map(refill => `
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-medium text-gray-900">${refill.name}</h4>
                            <p class="text-sm text-gray-600">${refill.dosage} • ${refill.schedule}</p>
                            <p class="text-xs text-gray-500">${window.i18n ? window.i18n.t('manageMedications.created') : 'Created'}: ${new Date(refill.created_at).toLocaleString()}</p>
                        </div>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${refill.medication_type === 'original' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                            ${refill.medication_type === 'original' ? (window.i18n ? window.i18n.t('manageMedications.original') : 'Original') : (window.i18n ? window.i18n.t('manageMedications.refill') : 'Refill')}
                        </span>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        async function createRefill(medicationId) {
            try {
                const response = await fetch(`${window.API_BASE}/medications/${medicationId}/refill-status`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showRefillConfirmationModal(data.medication, data.refillStatus);
                } else {
                    window.location.href = `add-medication.html?refill=${medicationId}`;
                }
            } catch (error) {
                console.error('Error getting refill status:', error);
                window.location.href = `add-medication.html?refill=${medicationId}`;
            }
        }

        function showRefillConfirmationModal(medication, refillStatus) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">${window.i18n ? window.i18n.t('manageMedications.createRefillTitle') : 'Create Refill'} - ${medication.name}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="p-4 rounded-lg ${getStatusColor(refillStatus.status)}">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-lg font-semibold">${window.i18n ? translateBackendValue(refillStatus.status, 'status').toUpperCase() : refillStatus.status.toUpperCase()}</span>
                                <span class="text-sm px-2 py-1 rounded-full ${getUrgencyColor(refillStatus.urgency)}">${window.i18n ? translateBackendValue(refillStatus.urgency, 'urgency') : refillStatus.urgency}</span>
                            </div>
                            <p class="text-sm">${window.i18n ? translateBackendMessage(refillStatus.message) : refillStatus.message}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.daysUntilRefill') : 'Days Until Refill'}:</span> ${refillStatus.daysUntilRefill}</div>
                            <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.supplyRemaining') : 'Supply Remaining'}:</span> ${refillStatus.daysOfSupplyRemaining} ${window.i18n ? window.i18n.t('manageMedications.days') : 'days'}</div>
                            <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.refillsLeft') : 'Refills Left'}:</span> ${refillStatus.refillsRemaining}</div>
                            <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.nextRefillDate') : 'Next Refill Date'}:</span> ${formatDate(refillStatus.refillDate)}</div>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button onclick="proceedWithRefill(${medication.id})" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                ${window.i18n ? window.i18n.t('manageMedications.createRefillNow') : 'Create Refill Now'}
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
                                ${window.i18n ? window.i18n.t('manageMedications.cancel') : 'Cancel'}
                            </button>
                        </div>
                        
                        <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg">
                            <p><strong>${window.i18n ? window.i18n.t('manageMedications.whatHappensWhenCreateRefill') : 'What happens when you create a refill:'}</strong></p>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li>${window.i18n ? window.i18n.t('manageMedications.newMedicationEntryCreated') : 'A new medication entry will be created as a refill'}</li>
                                <li>${window.i18n ? window.i18n.t('manageMedications.refillRemindersUpdated') : 'Your refill reminders will be updated'}</li>
                                <li>${window.i18n ? window.i18n.t('manageMedications.trackBothOriginalAndRefill') : 'You can track both original and refill medications'}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function proceedWithRefill(medicationId) {
            const modal = document.querySelector('.fixed');
            if (modal) {
                modal.remove();
            }
            
            window.location.href = `add-medication.html?refill=${medicationId}`;
        }

        async function refreshRefillReminders() {
            try {
                await loadMedications();
                
                if (typeof loadRefillReminders === 'function') {
                    loadRefillReminders();
                }
                
                showNotification(window.i18n ? window.i18n.t('manageMedications.refillCreatedSuccess') : 'Refill created successfully! Refill reminders have been updated.', 'success');
            } catch (error) {
                console.error('Error refreshing refill reminders:', error);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 z-50 max-w-sm bg-white border rounded-lg shadow-lg p-4 transition-all duration-300 transform translate-x-full`;
            
            const colors = {
                success: 'border-green-200 bg-green-50 text-green-800',
                error: 'border-red-200 bg-red-50 text-red-800',
                warning: 'border-yellow-200 bg-yellow-50 text-yellow-800',
                info: 'border-blue-200 bg-blue-50 text-blue-800'
            };
            
            notification.className += ` ${colors[type] || colors.info}`;
            
            notification.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        ${type === 'success' ? 'Success' : type === 'error' ? 'Error' : type === 'warning' ? 'Warning' : 'Info'}
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentMedication = null;
        }

        function closeRefillModal() {
            document.getElementById('refillModal').classList.add('hidden');
        }

        let medicationToDelete = null;

        function confirmDeleteMedication(medicationId, medicationName) {
            medicationToDelete = medicationId;
            document.getElementById('deleteMedicationName').textContent = medicationName;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            medicationToDelete = null;
        }

        async function deleteMedication() {
            if (!medicationToDelete) return;

            showLoading();
            
            try {
                const response = await window.API.deleteMedication(medicationToDelete);
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Medication deleted successfully!');
                    closeDeleteModal();
                    loadMedications();
                } else {
                    alert('Error deleting medication: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting medication:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function showEmptyState() {
            const container = document.getElementById('medicationsList');
            container.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                    </svg>
                    <p class="text-lg font-medium mb-2">No medications found</p>
                    <p class="text-sm text-gray-400 mb-4">Add your first medication to get started</p>
                    <button onclick="window.location.href='add-medication.html'" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        Add Medication
                    </button>
                </div>
            `;
        }

        function showErrorState() {
            const container = document.getElementById('medicationsList');
            container.innerHTML = `
                <div class="text-center text-red-500 py-12">
                    <p class="text-lg font-medium mb-2">Error loading medications</p>
                    <button onclick="loadMedications()" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        Try Again
                    </button>
                </div>
            `;
        }

        function showRefillStatusModal(data) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">${window.i18n ? window.i18n.t('manageMedications.refillStatus') : 'Refill Status'} - ${data.medication.name}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="p-4 rounded-lg ${getStatusColor(data.refillStatus.status)}">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-lg font-semibold">${window.i18n ? translateBackendValue(data.refillStatus.status, 'status').toUpperCase() : data.refillStatus.status.toUpperCase()}</span>
                                <span class="text-sm px-2 py-1 rounded-full ${getUrgencyColor(data.refillStatus.urgency)}">${window.i18n ? translateBackendValue(data.refillStatus.urgency, 'urgency') : data.refillStatus.urgency}</span>
                            </div>
                            <p class="text-sm">${window.i18n ? window.i18n.t('manageMedications.supplyGoodMessage', { medication: data.medication.name, days: data.refillStatus.daysOfSupplyRemaining }) : `${data.medication.name} supply is good (${data.refillStatus.daysOfSupplyRemaining} days remaining)`}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.daysUntilRefill') : 'Days Until Refill'}:</span> ${data.refillStatus.daysUntilRefill}</div>
                            <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.daysOfSupplyRemaining') : 'Days of Supply Remaining'}:</span> ${data.refillStatus.daysOfSupplyRemaining}</div>
                            <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.refillDate') : 'Refill Date'}:</span> ${formatDate(data.refillStatus.refillDate)}</div>
                            <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.refillsRemaining') : 'Refills Remaining'}:</span> ${data.refillStatus.refillsRemaining}</div>
                        </div>
                        
                        ${data.calculationComparison ? `
                            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <h4 class="font-medium text-blue-900 mb-2">${window.i18n ? window.i18n.t('manageMedications.calculationComparison') : 'Calculation Comparison'}</h4>
                                <div class="text-sm text-blue-800">
                                    <p><strong>${window.i18n ? window.i18n.t('manageMedications.recommendation') : 'Recommendation'}:</strong> ${data.calculationComparison.recommendation === 'Pharmacy estimate is accurate for this schedule' ? 
                                        (window.i18n ? window.i18n.t('manageMedications.pharmacyEstimateAccurate') : 'Pharmacy estimate is accurate for this schedule')
                                        : data.calculationComparison.recommendation}</p>
                                    <p><strong>${window.i18n ? window.i18n.t('manageMedications.difference') : 'Difference'}:</strong> ${data.calculationComparison.difference.days} ${window.i18n ? window.i18n.t('manageMedications.days') : 'days'} (${data.calculationComparison.difference.percentageChange}${window.i18n ? window.i18n.t('manageMedications.percent') : '%'})</p>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showRefillCalculationModal(data) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">${window.i18n ? window.i18n.t('manageMedications.refillCalculationDetails') : 'Refill Calculation Details'} - ${data.medication.name}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${data.comparison.comparison === 'available' ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                    <h4 class="font-medium text-gray-900 mb-3">${window.i18n ? window.i18n.t('manageMedications.pharmacyEstimate') : 'Pharmacy Estimate (Basic)'}</h4>
                                    <div class="space-y-2 text-sm">
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.refillDate') : 'Refill Date'}:</span> ${data.comparison.basic.refillDate}</div>
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.daysUntil') : 'Days Until'}:</span> ${data.comparison.basic.daysUntil}</div>
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.daysSupply') : 'Days Supply'}:</span> ${data.comparison.basic.daysSupply}</div>
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.assumption') : 'Assumption'}:</span> ${data.comparison.basic.assumption === 'Daily consumption' ? (window.i18n ? window.i18n.t('manageMedications.dailyConsumption') : 'Daily consumption') : data.comparison.basic.assumption}</div>
                                    </div>
                                </div>
                                
                                <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <h4 class="font-medium text-blue-900 mb-3">${window.i18n ? window.i18n.t('manageMedications.enhancedCalculation') : 'Enhanced Calculation'}</h4>
                                    <div class="space-y-2 text-sm">
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.refillDate') : 'Refill Date'}:</span> ${data.comparison.enhanced.refillDate}</div>
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.daysUntil') : 'Days Until'}:</span> ${data.comparison.enhanced.daysUntil}</div>
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.daysSupply') : 'Days Supply'}:</span> ${data.comparison.enhanced.daysSupply}</div>
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.consumptionRate') : 'Consumption Rate'}:</span> ${data.comparison.enhanced.consumptionRate} ${window.i18n ? window.i18n.t('manageMedications.dosesPerDay') : 'doses/day'}</div>
                                        <div><span class="font-medium">${window.i18n ? window.i18n.t('manageMedications.scheduleUsed') : 'Schedule Used'}:</span> ${data.comparison.enhanced.assumption.startsWith('Schedule: ') ? 
                                            (window.i18n ? window.i18n.t('manageMedications.schedulePrefix') : 'Schedule: ') + 
                                            (window.i18n ? translateMedicationInstruction(data.comparison.enhanced.assumption.replace('Schedule: ', '')) : data.comparison.enhanced.assumption.replace('Schedule: ', ''))
                                            : data.comparison.enhanced.assumption}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                                <h4 class="font-medium text-green-900 mb-2">${window.i18n ? window.i18n.t('manageMedications.analysis') : 'Analysis'}</h4>
                                <div class="text-sm text-green-800">
                                    <p><strong>${window.i18n ? window.i18n.t('manageMedications.difference') : 'Difference'}:</strong> ${data.comparison.difference.days} ${window.i18n ? window.i18n.t('manageMedications.days') : 'days'} (${data.comparison.difference.percentageChange}${window.i18n ? window.i18n.t('manageMedications.percent') : '%'})</p>
                                    <p><strong>${window.i18n ? window.i18n.t('manageMedications.recommendation') : 'Recommendation'}:</strong> ${data.comparison.recommendation === 'Pharmacy estimate is accurate for this schedule' ? 
                                        (window.i18n ? window.i18n.t('manageMedications.pharmacyEstimateAccurate') : 'Pharmacy estimate is accurate for this schedule')
                                        : data.comparison.recommendation}</p>
                                </div>
                            </div>
                        ` : `
                            <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                <p class="text-yellow-800">${data.comparison.message}</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showRefillRemindersModal(medicationId, reminders) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">${window.i18n ? window.i18n.t('manageMedications.refillReminders.title') : 'Refill Reminders'}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6L6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${reminders.length > 0 ? `
                            <div class="space-y-3">
                                ${reminders.map(reminder => `
                                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="font-medium text-gray-900">${reminder.medication_name}</div>
                                                <div class="text-sm text-gray-600">${window.i18n ? window.i18n.t('manageMedications.refillDue') : 'refill due'} - ${formatDateInUserLanguage(reminder.reminder_date)}</div>
                                                <div class="text-sm text-gray-500">${reminder.message ? translateReminderMessage(reminder.message, reminder.medication_name) : (window.i18n ? window.i18n.t('manageMedications.noMessage') : 'No message')}</div>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="px-2 py-1 text-xs rounded-full ${getReminderStatusColor(reminder.status)}">${window.i18n ? window.i18n.t(`manageMedications.${reminder.status}`) : reminder.status}</span>
                                                <button onclick="updateReminderStatus(${reminder.id}, 'dismissed')" class="text-xs text-gray-500 hover:text-gray-700">${window.i18n ? window.i18n.t('manageMedications.dismiss') : 'Dismiss'}</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center text-gray-500 py-8">
                                <p class="mb-4">${window.i18n ? window.i18n.t('manageMedications.noRefillRemindersFound') : 'No refill reminders found for this medication.'}</p>
                                <button onclick="generateRefillReminders(${medicationId})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                    ${window.i18n ? window.i18n.t('manageMedications.generateReminders') : 'Generate Reminders'}
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function getStatusColor(status) {
            const colors = {
                'good': 'bg-green-100 border-green-200 text-green-800',
                'low': 'bg-yellow-100 border-yellow-200 text-yellow-800',
                'overdue': 'bg-red-100 border-red-200 text-red-800',
                'due_soon': 'bg-orange-100 border-orange-200 text-orange-800'
            };
            return colors[status] || 'bg-gray-100 border-gray-200 text-gray-800';
        }

        function getUrgencyColor(urgency) {
            const colors = {
                'low': 'bg-gray-100 text-gray-800',
                'medium': 'bg-yellow-100 text-yellow-800',
                'high': 'bg-red-100 text-red-800'
            };
            return colors[urgency] || 'bg-gray-100 text-gray-800';
        }

        function getReminderStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'sent': 'bg-green-100 text-green-800',
                'dismissed': 'bg-gray-100 text-gray-800',
                'taken': 'bg-blue-100 text-blue-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        async function updateReminderStatus(reminderId, status) {
            try {
                const response = await fetch(`${window.API_BASE}/refill-reminders/${reminderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ status })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const modal = document.querySelector('.fixed');
                    if (modal) {
                        modal.remove();
                    }
                } else {
                    alert('Error updating reminder status: ' + data.message);
                }
            } catch (error) {
                console.error('Error updating reminder status:', error);
                alert('Error: ' + error.message);
            }
        }

        function showLoading() {
            const loadingElement = document.getElementById('loadingState');
            if (loadingElement) {
                loadingElement.classList.remove('hidden');
            }
        }

        function hideLoading() {
            const loadingElement = document.getElementById('loadingState');
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', deleteMedication);

        async function viewRefillStatus(medicationId) {
            try {
                showLoading();
                const response = await fetch(`${window.API_BASE}/medications/${medicationId}/refill-status`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showRefillStatusModal(data);
                } else {
                    alert('Error loading refill status: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading refill status:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function viewRefillCalculation(medicationId) {
            try {
                showLoading();
                const response = await fetch(`${window.API_BASE}/medications/${medicationId}/refill-calculation`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showRefillCalculationModal(data);
                } else {
                    alert('Error loading refill calculation: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading refill calculation:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function manageRefillReminders(medicationId) {
            try {
                showLoading();
                const response = await fetch(`${window.API_BASE}/refill-reminders?medication_id=${medicationId}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showRefillRemindersModal(medicationId, data.reminders);
                } else {
                    alert('Error loading refill reminders: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading refill reminders:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function generateRefillReminders(medicationId) {
            try {
                showLoading();
                const response = await fetch(`${window.API_BASE}/medications/${medicationId}/refill-reminders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({})
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Successfully generated ${data.reminders.length} refill reminders!`);
                    manageRefillReminders(medicationId);
                } else {
                    alert('Error generating refill reminders: ' + data.message);
                }
            } catch (error) {
                console.error('Error generating refill reminders:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentMedication) return;
            
            const formData = {
                name: document.getElementById('editName').value.trim(),
                dosage: document.getElementById('editDosage').value.trim(),
                schedule: document.getElementById('editSchedule').value.trim(),
                specific_time: document.getElementById('editSpecificTime').value || null,
                use_specific_time: !!document.getElementById('editSpecificTime').value,
                action: 'edit'
            };
            
            if (!formData.name || !formData.dosage || !formData.schedule) {
                alert('Please fill in all required fields');
                return;
            }
            
            showLoading();
            
            try {
                const response = await window.API.updateMedication(currentMedication.id, formData);
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Medication updated successfully!');
                    closeEditModal();
                    loadMedications();
                } else {
                    alert('Error updating medication: ' + result.message);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        window.translateMedicationInstruction = translateMedicationInstruction;
        window.refreshDynamicContent = refreshDynamicContent;
        
        function ensureI18nLoaded() {
            if (!window.i18n) {
                setTimeout(ensureI18nLoaded, 100);
                return;
            }
            
            window.i18n.applyLanguage();
        }
        
        ensureI18nLoaded();
        
        setInterval(() => {
            if (window.i18n) {
                const currentLang = window.i18n.getCurrentLanguage();
                const savedLang = localStorage.getItem('language') || 'en';
                if (currentLang !== savedLang) {
                    refreshStaticContent();
                    refreshDynamicContent();
                }
            }
        }, 5000);
    </script>
    
    <script type="module" src="i18n.js"></script>
    <script type="module" src="api-utils.js"></script>
    <script type="module" src="auth.js"></script>
    <script type="module" src="auth-guard.js"></script>
</body>
</html> 